!function(e){e.richFilemanagerPlugin=function(t,o){function i(t,o){return-1===j.indexOf(o)?!1:"folder"===t.type&&"replace"===o?!1:"folder"===t.type&&"select"===o?!1:"folder"===t.type&&"download"===o?y.security.allowFolderDownload===!0:"undefined"!=typeof t.attributes.capabilities?e.inArray(o,t.attributes.capabilities)>-1:!0}function r(){y.filetree.enabled&&(v.show(),h.splitter({sizeLeft:y.filetree.width,minLeft:y.filetree.minWidth,minRight:200}),F.treeModel.loadNodes(null,{refresh:!1}))}function n(){F.itemsModel.loadList(C)}function a(){return window.opener||window.parent&&window.self!==window.parent||window.tinyMCEPopup||E.param("field_name")||E.param("CKEditor")||E.param("ImperaviElementId")}function s(e){var t=!F.clipboardModel.enabled(),o={select:{name:M.action_select,className:"select"},download:{name:M.action_download,className:"download"},rename:{name:M.action_rename,className:"rename"},move:{name:M.action_move,className:"move"},replace:{name:M.action_replace,className:"replace"},separator1:"-----",copy:{name:M.clipboard_copy,className:"copy"},cut:{name:M.clipboard_cut,className:"cut"},"delete":{name:M.action_delete,className:"delete"}};return i(e,"download")||delete o.download,i(e,"select")&&a()||delete o.select,i(e,"rename")&&y.options.browseOnly!==!0||delete o.rename,i(e,"delete")&&y.options.browseOnly!==!0||delete o["delete"],(!i(e,"copy")||y.options.browseOnly===!0||t)&&delete o.copy,(!i(e,"move")||y.options.browseOnly===!0||t)&&(delete o.cut,delete o.move),delete o.replace,o}var l={baseUrl:".",config:{url:"/config/"},callbacks:{beforeCreateImageUrl:function(e,t){return t},beforeCreatePreviewUrl:function(e,t){return t},beforeSelectItem:function(e,t){return t},afterSelectItem:function(e,t,o){}}},d=this,c=e(t),u=c.children(".fm-wrapper"),p=u.find(".fm-header"),f=p.find(".fm-uploader"),h=u.children(".fm-splitter"),m=u.children(".fm-footer"),b=h.children(".fm-fileinfo"),v=h.children(".fm-filetree"),g=b.find(".view-items"),w=f.children(".fm-upload"),y=null,M=null,C="/",x=null,k=!0,j=[],S=null,_=null,F=null,N=75,O=null,E=purl(),I=(new Date).getTime();d.settings=e.extend(!0,l,o),d.log=function(t,o){var i=alertify,r=e.extend({},{reset:!0,delay:5e3,logMaxItems:5,logPosition:"bottom right",logContainerClass:"fm-log",parent:e(".fm-popup").is(":visible")?document.body:b[0],onClick:void 0,unique:!1,type:"log"},o);return r.logClass&&r.unique&&e(".fm-log").children("."+r.logClass).length>0?i:(r.reset&&i.reset(),r.parent&&i.parent(r.parent),i.logDelay(r.delay),i.logMaxItems(r.logMaxItems),i.logPosition(r.logPosition),i.logContainerClass(r.logContainerClass),i[r.type](t,r.onClick),i)},d.error=function(t,o){return d.log(t,e.extend({},{type:"error",delay:1e4},o))},d.warning=function(t,o){return d.log(t,e.extend({},{type:"warning",delay:1e4},o))},d.success=function(t,o){return d.log(t,e.extend({},{type:"success",delay:6e3},o))},d.alert=function(e){alertify.reset().dialogContainerClass("fm-popup").alert(e)},d.confirm=function(e){alertify.reset().dialogWidth(e.width).dialogPersistent(e.persistent).dialogContainerClass("fm-popup").confirm(e.message,e.okBtn,e.cancelBtn)},d.prompt=function(e){alertify.reset().dialogWidth(e.width).dialogPersistent(e.persistent).dialogContainerClass("fm-popup").theme(e.template).prompt(e.message,e.value||"",e.okBtn,e.cancelBtn)},d.dialog=function(e){alertify.reset().dialogWidth(e.width).dialogPersistent(e.persistent).dialogContainerClass("fm-popup").dialog(e.message,e.buttons)},d.setDimensions=function(){var t=u.outerHeight(!0)-u.height(),o=e(window).height()-p.height()-m.height()-t,i=h.width()-h.children(".splitter-bar-vertical").outerWidth()-v.outerWidth();h.height(o),b.width(i)};var L=function(){var t=e.Deferred();t.then(function(){return T()}).then(function(e,t){return P()}).then(function(){return D()}).then(function(){return z()}).then(function(){U(function(){A()})}),t.resolve()},T=function(){return e.when(G("default"),G("user")).done(function(t,o){var i=t[0],r=o[0];if(void 0!==r&&null!==r&&delete r.version,y=e.extend({},i,r),y.api.connectorUrl)x=y.api.connectorUrl;else{var n=location.origin+location.pathname,a="connectors/"+y.api.lang+"/filemanager."+y.api.lang;ie(n).length>0&&(n=n.substring(0,n.lastIndexOf("/")+1)),x=n+a}})},P=function(){return e.ajax({type:"GET",url:fe({mode:"initiate"}),dataType:"json"}).done(function(t){if(t.data){var o=t.data.attributes.config;e.each(o,function(t,o){e.each(o,function(e,o){"undefined"!==y[t]&&"undefined"!==y[t][e]&&(y[t][e]=o)})})}Y(t)}).fail(function(){d.error("Unable to perform initial request to server.")}).then(function(t){return t.errors?e.Deferred().reject():void 0})},D=function(){function t(e){return i+e+".json"}var o=E.param("langCode"),i=d.settings.baseUrl+y.paths.languages;return e.ajax().then(function(){return o?W(t(o)).done(function(){y.options.culture=o}).fail(function(){setTimeout(function(){d.error("Given language file ("+t(o)+") does not exist!")},500)}):void 0}).then(function(){return e.ajax({type:"GET",url:t(y.options.culture),dataType:"json"}).done(function(e){M=e})})},z=function(){return e.when(q("upload-container"),q("upload-item")).done(function(e,t){var o=e[0],i=t[0];u.append(o).append(i)})},U=function(e){var t=[],o=[];if(t.push(y.paths.themes+y.options.theme+"/styles/theme.css"),y.customScrollbar.enabled&&(t.push(y.paths.styles+"custom-scrollbar-plugin/jquery.mCustomScrollbar.min.css"),t.push(y.paths.scripts+"custom-scrollbar-plugin/jquery.mCustomScrollbar.concat.min.js")),t.push(e),H(t),y.viewer.editable.enabled){var i=y.viewer.editable.theme;i&&"default"!==i&&o.push(y.paths.styles+"CodeMirror/theme/"+i+".css"),o.push(y.paths.styles+"CodeMirror/lib/codemirror.css"),o.push(y.paths.scripts+"CodeMirror/lib/codemirror.js"),o.push(y.paths.scripts+"CodeMirror/addon/selection/active-line.js"),o.push(y.paths.styles+"CodeMirror/addon/display/fullscreen.css"),o.push(y.paths.scripts+"CodeMirror/addon/display/fullscreen.js")}y.options.browseOnly||(o.push(y.paths.scripts+"jQuery-File-Upload/js/vendor/jquery.ui.widget.js"),o.push(y.paths.scripts+"jQuery-File-Upload/js/canvas-to-blob.min.js"),o.push(y.paths.scripts+"jQuery-File-Upload/js/load-image.all.min.js"),o.push(y.paths.scripts+"jQuery-File-Upload/js/jquery.iframe-transport.js"),o.push(y.paths.scripts+"jQuery-File-Upload/js/jquery.fileupload.js"),o.push(y.paths.scripts+"jQuery-File-Upload/js/jquery.fileupload-process.js"),o.push(y.paths.scripts+"jQuery-File-Upload/js/jquery.fileupload-image.js"),o.push(y.paths.scripts+"jQuery-File-Upload/js/jquery.fileupload-validate.js"),y.upload.multiple&&o.push(y.paths.styles+"jQuery-File-Upload/css/dropzone.css")),y.options.charsLatinOnly&&o.push(y.paths.scripts+"speakingurl/speakingurl.min.js"),o.length&&H(o)},A=function(){j=y.options.capabilities||["upload","select","download","rename","copy","move","delete","replace"];var t=[];y.options.fileSorting&&(t=y.options.fileSorting.toLowerCase().split("_")),S=t[0]||"name",_=t[1]||"asc",k=y.options.sortingEnabled;var o=E.param("exclusiveFolder");o&&(C="/"+o+"/",C=oe(C));var i=E.param("expandedFolder");if(i&&(O=C+i+"/",O=oe(O)),F=new B,ko.applyBindings(F),ko.bindingHandlers.toggleNodeVisibility={init:function(t,o){var i=o();e(t).toggle(i.isExpanded())},update:function(t,o){var i=o();return i.isSliding()===!1?!1:(i.isExpanded()===!1&&e(t).slideDown(y.filetree.expandSpeed,function(){i.isSliding(!1),i.isExpanded(!0)}),void(i.isExpanded()===!0&&e(t).slideUp(y.filetree.expandSpeed,function(){i.isSliding(!1),i.isExpanded(!1)})))}},ko.bindingHandlers.draggableView={init:function(t,o,i){var r=o();("file"===r.rdo.type||"folder"===r.rdo.type)&&e(t).draggable({distance:3,cursor:"pointer",refreshPositions:!1,helper:function(){var t,o=F.itemsModel.getSelected(),i="drag-helper-"+F.viewMode(),r=e("<div>",{"class":i});return t=o.length>1?e("#drag-helper-"+F.viewMode()+"-template").clone():e(this).clone(),r.append(t.html())},appendTo:y.customScrollbar.enabled?b.find(".mCustomScrollBox"):b,start:function(e,t){r.selected()||(F.itemsModel.unselectItems(!1),r.selected(!0))},drag:function(t,o){e(this).draggable("option","refreshPositions",F.itemsModel.isScrolling())}})}},ko.bindingHandlers.droppableView={init:function(t,o,i){function r(t,o){var i=e.grep(o,function(e,o){return e.id===t.id});return t.rdo.attributes.writable&&0===i.length}("folder"===o().rdo.type||"parent"===o().rdo.type)&&e(t).droppable({enableExtendedEvents:!0,accept:function(e){var t=ko.dataFor(e[0]),o=t?t.rdo.type:null;return"file"===o||"folder"===o},over:function(t,o){var i=ko.dataFor(t.target),n=F.itemsModel.getSelected();r(i,n)?e(this).addClass("drop-hover"):o.helper.addClass("drop-restricted")},out:function(t,o){e(this).removeClass("drop-hover"),o.helper.removeClass("drop-restricted")},drop:function(t,o){var i=ko.dataFor(t.target),n=F.itemsModel.getSelected();return e(t.target).removeClass("drop-hover"),r(i,n)?void ge(n,function(e,t){return je(t.rdo,i.id)}):!1}})}},g.selectable({filter:"li:not(.directory-parent), tbody > tr:not(.directory-parent)",cancel:".directory-parent, thead",disabled:!y.manager.selection.enabled,appendTo:g,start:function(e,t){we(),F.itemsModel.isSelecting(!0)},stop:function(e,t){F.itemsModel.isSelecting(!1)},selected:function(e,t){var o=ko.dataFor(t.selected);o.selected(!0)},unselected:function(e,t){var o=ko.dataFor(t.unselected);o.selected(!1)}}),ko.bindingHandlers.draggableTree={init:function(t,o,i){var r=o();("file"===r.rdo.type||"folder"===r.rdo.type)&&e(t).draggable({distance:3,cursor:"pointer",refreshPositions:!1,helper:function(){return e("<li>").append(e(this).clone())},appendTo:y.customScrollbar.enabled?v.find(".mCustomScrollBox"):v,drag:function(t,o){e(this).draggable("option","refreshPositions",F.treeModel.isScrolling())}})}},ko.bindingHandlers.droppableTree={init:function(t,o,i){("folder"===o().rdo.type||"parent"===o().rdo.type)&&e(t).droppable({hoverClass:"drop-hover",accept:function(t){if(t.closest("ul").prev("a").is(e(this)))return!1;if(e.contains(t.parent()[0],this))return!1;var o=ko.dataFor(t[0]),i=o?o.rdo.type:null;return"file"===i||"folder"===i},drop:function(e,t){je(ko.dataFor(t.draggable[0]),ko.dataFor(e.target).id)}})}},b.contextMenu({selector:".view-items",zIndex:10,build:function(e,t){var o={createFolder:{name:M.create_folder,className:"create-folder"},paste:{name:M.clipboard_paste,className:"paste",disabled:function(e,t){return F.clipboardModel.isEmpty()}}};return F.clipboardModel.enabled()&&y.options.browseOnly!==!0||delete o.paste,{appendTo:".fm-container",items:o,reposition:!1,callback:function(e,t){switch(e){case"createFolder":F.headerModel.createFolder();break;case"paste":F.clipboardModel.paste()}}}}}),y.extras.extra_js)for(var a=0;a<y.extras.extra_js.length;a++)e.ajax({type:"GET",url:y.extras.extra_js[a],dataType:"script",async:y.extras.extra_js_async});E.param("CKEditorCleanUpFuncNum")&&(F.headerModel.closeButton(!0),F.headerModel.closeButtonOnClick=function(){parent.CKEDITOR.tools.callFunction(E.param("CKEditorCleanUpFuncNum"))}),e("#newfile").change(function(){e("#filepath").val(e(this).val().replace(/.+[\\\/]/,""))}),r(),n(),Te(),y.customScrollbar.enabled&&(v.mCustomScrollbar({theme:y.customScrollbar.theme,scrollButtons:{enable:y.customScrollbar.button},advanced:{autoExpandHorizontalScroll:!0,updateOnContentResize:!0},callbacks:{onScrollStart:function(){F.treeModel.isScrolling(!0)},onScroll:function(){F.treeModel.isScrolling(!1)},whileScrolling:function(){F.loadingFolders()||y.options.lazy&&F.treeModel.onCustomScrolling(-1*this.mcs.top+this.mcs.content.parent().height())}},axis:"yx"}),b.find(".fm-preview").mCustomScrollbar({theme:y.customScrollbar.theme,scrollButtons:{enable:y.customScrollbar.button},advanced:{autoExpandHorizontalScroll:!0,updateOnContentResize:!0,updateOnSelectorChange:".fm-preview-viewer"}}),b.find(".view-items-wrapper").mCustomScrollbar({theme:y.customScrollbar.theme,scrollButtons:{enable:y.customScrollbar.button},advanced:{autoExpandHorizontalScroll:!0,updateOnContentResize:!0,updateOnSelectorChange:".grid, .list"},callbacks:{onScrollStart:function(){F.itemsModel.continiousSelection()||(this.yStartPosition=this.mcs.top,this.yStartTime=(new Date).getTime()),F.itemsModel.isScrolling(!0)},onScroll:function(){F.itemsModel.isScrolling(!1)},whileScrolling:function(){if(F.loadingFiles()||y.options.lazy&&F.itemsModel.onCustomScrolling(this.mcs.topPct),y.manager.selection.enabled){var e=(new Date).getTime()-this.yStartTime;!F.itemsModel.continiousSelection()&&e>400&&(this.yStartPosition=this.mcs.top),F.itemsModel.isSelecting()&&F.itemsModel.continiousSelection(!0);var t=Math.abs(this.mcs.top)-Math.abs(this.yStartPosition);g.selectable("repositionCssHelper",t,0)}}},axis:"y",alwaysShowScrollbar:0}));var s=document.documentElement;if(s.setAttribute("data-useragent",navigator.userAgent),y.options.logger){var l=(new Date).getTime(),u=l-I;console.log("Total execution time : "+u+" ms")}var p=c.find(".fm-loading-wrap");p.fadeOut(800,function(){d.setDimensions()}),d.setDimensions()},B=function(){var t=this;this.config=ko.observable(y),this.lg=ko.observable(M),this.localizeGUI=ko.observable(y.options.localizeGUI),this.loadingView=ko.observable(!0),this.loadingFiles=ko.observable(!1),this.loadingFolders=ko.observable(!1),this.previewFile=ko.observable(!1),this.viewMode=ko.observable(y.options.defaultViewMode),this.currentPath=ko.observable(C),this.browseOnly=ko.observable(y.options.browseOnly),this.canCreateFolders=ko.observable(y.options.canCreateFolders),this.previewFile.subscribe(function(e){e||t.previewModel.closeEditor()}),this.addItem=function(e,t){var o=F.treeModel.findByParam("id",t);if(o){var i=F.treeModel.createNode(e);F.treeModel.addNodes(o,i)}F.currentPath()===t&&F.itemsModel.addNew(e)},this.removeItem=function(e){var t=F.treeModel.findByParam("id",e.id);t&&t.remove();var o=F.itemsModel.findByParam("id",e.id);o&&o.remove()};var o=function(){var e=this;this.rdo=ko.observable({}),this.cdo=ko.observable({}),this.viewer=ko.observable({}),this.editor={enabled:ko.observable(!1),content:ko.observable(""),codeMirror:ko.observable(null)},this.bindToolbar=function(t){i(e.rdo(),t)&&Le(t,e.rdo())},this.load=function(o){t.previewFile(!1),e.rdo(o),e.cdo({isFolder:"folder"===o.type,sizeFormatted:$(o.attributes.size),dimensions:o.attributes.width?o.attributes.width+"x"+o.attributes.height:null});var i=o.attributes.name,r={type:"image",url:me(o,!1),options:{}};se(i)&&y.viewer.editable.enabled===!0&&(r.type="editable"),ce(i)&&y.viewer.audio.enabled===!0&&(r.type="audio",r.url=he(o,!0)),de(i)&&y.viewer.video.enabled===!0&&(r.type="video",r.url=he(o,!0),r.options={width:y.viewer.video.playerWidth,height:y.viewer.video.playerHeight}),ue(i)&&y.viewer.opendoc.enabled===!0&&(r.type="opendoc",r.url=d.settings.baseUrl+"/scripts/ViewerJS/index.html#"+he(o,!0),r.options={width:y.viewer.opendoc.readerWidth,height:y.viewer.opendoc.readerHeight}),pe(i)&&y.viewer.google.enabled===!0&&(r.type="google",r.url="http://docs.google.com/viewer?url="+encodeURIComponent(he(o,!1))+"&embedded=true",r.options={width:y.viewer.google.readerWidth,height:y.viewer.google.readerHeight}),this.previewIconClass=ko.pureComputed(function(){var e=[],t=["ico"];return"image"!==r.type&&"editable"!==r.type||r.url||(e.push("grid-icon"),this.cdo().isFolder===!0?(e.push("ico_folder"),t.push("folder"),this.rdo().attributes.readable||t.push("lock")):(e.push("ico_file"),this.rdo().attributes.readable?t.push("ext",this.rdo().attributes.extension):t.push("file","lock")),e.push(t.join("_"))),e.join(" ")},this),e.viewer(r),t.previewFile(!0),ZeroClipboard.config({swfPath:d.settings.baseUrl+y.paths.flash+"zeroclipboard/dist/ZeroClipboard.swf"});var n=new ZeroClipboard(document.getElementById("fm-js-clipboard-copy"));n.on("ready",function(e){n.on("aftercopy",function(e){d.success(M.copied)})})},this.editFile=function(){Ne(e.rdo())},this.saveFile=function(){Oe(e.rdo())},this.closeEditor=function(){e.editor.enabled(!1)},this.buttonVisibility=function(t){switch(t){case"select":return i(e.rdo(),t)&&a();case"move":case"rename":case"delete":case"replace":return i(e.rdo(),t)&&y.options.browseOnly!==!0;case"download":return i(e.rdo(),t)}}},r=function(){var o=this;this.isScrolling=ko.observable(!1),this.selecledNode=ko.observable(null),this.currentNode=ko.observable(null),this.treeData={id:C,level:ko.observable(-1),children:ko.observableArray([])},this.treeData.children.subscribe(function(e){o.arrangeNode(o.treeData)});var i=function(e){if(null!==O){e||(e=o.treeData);var t=o.findByFilter(function(e){return 0===O.indexOf(e.id)},e);t?(y.filetree.expandSpeed=10,o.loadNodes(t,{refresh:!1})):(O=null,y.filetree.expandSpeed=200)}};this.findByParam=function(e,t,i){if(!i&&(i=o.treeData,i[e]===t))return i;var r=i.children();if(!r||0===r.length)return null;for(var n=0,a=r.length;a>n;n++){if(r[n][e]===t)return r[n];var s=o.findByParam(e,t,r[n]);if(s)return s}return null},this.findByFilter=function(e,t){if(!t&&(t=o.treeData,e(t)))return t;var i=t.children();if(!i||0===i.length)return null;for(var r=0,n=i.length;n>r;r++){if(e(i[r]))return i[r];var a=o.findByFilter(e,i[r]);if(a)return a}return null},this.loadNodes=function(r,n){t.loadingFolders(!0);var a=r?r.id:o.treeData.id,s=t.treeModel.currentNode()?t.treeModel.currentNode().children().length:0;r&&r.isLoaded(!1),typeof{}!=typeof n&&(n={});var l={mode:"getfolder",path:a};E.param("type")&&(l.type=E.param("type"));var d={};n.skip&&(d.skip=s),n.load&&"split"===y.options.filemanagerMode&&(d.load=n.load),e.ajax({type:"GET",url:fe(l),dataType:"json",data:d,cache:!1,success:function(s){if(s.data&&s.data.tree){F.currentPath(a),F.breadcrumbsModel.splitCurrent(),o.currentNode(r),!r||void 0===r.isDone||n.refresh?(F.itemsModel.setList(s.data.tree),t.itemsModel.isDone(!1)):(F.itemsModel.extendList(s.data.tree),t.itemsModel.isDone(s.data.done));var l=[];e.each(s.data.tree,function(e,t){var i=o.createNode(t);l.push(i)}),n.refresh&&r.children([]),o.addNodes(r,l),r&&(r.isLoaded(!0),o.expandNode(r),r.isDone=s.data.done),i(r),t.loadingFolders(!1)}Y(s)},error:Q})},this.createNode=function(e){return new r(e)},this.addNodes=function(t,i){e.isArray(i)||(i=[i]),t||(t=o.treeData),y.filetree.foldersOnly&&(i=e.grep(i,function(e){return e.cdo.isFolder})),e.each(i,function(e,o){o.parentNode(t)});var r=t.children().concat(i);t.children(R(r,"split"===y.options.filemanagerMode?"files":""))},this.expandNode=function(e){return e.isExpanded()===!1&&e.isLoaded()===!0?(e.isSliding(!0),!0):!1},this.collapseNode=function(e){return e.isExpanded()===!0?(e.isSliding(!0),!0):!1},this.toggleNode=function(e){o.collapseNode(e)||o.expandNode(e)},this.arrangeNode=function(t){var o=t.children().length;e.each(t.children(),function(e,i){i.level(t.level()+1),i.isFirstNode(0===e),i.isLastNode(e===o-1)})},this.nodeRendered=function(t,o){e(t[1]).contextMenu({selector:".file, .directory",zIndex:100,build:function(e,t){return{appendTo:".fm-container",items:s(o.rdo),callback:function(e,t){Le(e,o.rdo)}}}})},this.actualizeNodeObject=function(t,i,r){var n=new RegExp("^"+i),a=t.rdo.id,s=a.replace(n,r);t.id=s,t.rdo.id=s,t.rdo.attributes.path=t.rdo.attributes.path.replace(new RegExp(a+"$"),s),t.children().length&&e.each(t.children(),function(e,t){o.actualizeNodeObject(t,i,r)})},this.onCustomScrolling=function(o){var i=t.treeModel.currentNode();i.children().length||(i=i.parentNode());var r=i.children().length;if(r){var n=Math.round(r*N/100),a=i.children()[n].rdo.attributes.name,s=e('span.node_name:contains("'+a+'")');o>=s.position().top&&!0!==t.treeModel.currentNode().isDone&&t.treeModel.loadNodes(t.treeModel.currentNode(),{load:1,skip:!0})}};var r=function(t){var i=this;this.id=t.id,this.rdo=t,this.cdo={isFolder:"folder"===t.type,dimensions:t.attributes.width?t.attributes.width+"x"+t.attributes.height:null,cssItemClass:"folder"===t.type?"directory":"file"},this.nodeTitle=ko.observable(t.attributes.name),this.children=ko.observableArray([]),this.parentNode=ko.observable(null),this.isSliding=ko.observable(!1),this.isLoading=ko.observable(!1),this.isLoaded=ko.observable(!1),this.isExpanded=ko.observable(!1),this.isSelected=ko.observable(!1),this.level=ko.observable(0),this.isFirstNode=ko.observable(!1),this.isLastNode=ko.observable(!1),this.nodeTitle.subscribe(function(e){i.rdo.attributes.name=e}),this.children.subscribe(function(e){o.arrangeNode(i)}),this.isLoaded.subscribe(function(e){i.isLoading(!e)}),this.switchNode=function(e){return e.cdo.isFolder?e.rdo.attributes.readable?void(!e.isLoaded()||y.filetree.reloadOnClick?i.openNode(e,"split"===y.options.filemanagerMode?{load:1}:{}):o.toggleNode(e)):(d.error(M.NOT_ALLOWED_SYSTEM),!1):!1},this.nodeClick=function(e){y.manager.dblClickOpen||i.openNode(e),null!==o.selecledNode()&&o.selecledNode().isSelected(!1),e.isSelected(!0),o.selecledNode(e)},this.nodeDblClick=function(e){y.manager.dblClickOpen&&i.openNode(e)},this.openNode=function(t,i){if("file"===t.rdo.type&&Ie(t.rdo),"folder"===t.rdo.type)if(!t.isLoaded()||t.isExpanded()&&(y.filetree.reloadOnClick||"split"===y.options.filemanagerMode))o.loadNodes(t,Object.assign({},i,{refresh:!0}));else{o.toggleNode(t,!1),F.currentPath(t.id),F.breadcrumbsModel.splitCurrent();var r=[];e.each(t.children(),function(e,t){r.push(t.rdo)}),F.itemsModel.setList(r)}},this.remove=function(){i.parentNode().children.remove(i)},this.isRoot=function(){return i.level()===o.treeData.id},this.title=ko.pureComputed(function(){return y.options.showTitleAttr?this.rdo.id:null},this),this.iconClass=ko.pureComputed(function(){var e,t=["ico"];return this.cdo.isFolder===!0?(e="ico_folder",this.isLoading()===!0?t.push("loading"):(t.push("folder"),this.rdo.attributes.readable?(this.isExpanded()||!this.isExpanded()&&this.isSliding())&&t.push("open"):t.push("lock"))):(e="ico_file",this.rdo.attributes.readable?t.push("ext",this.rdo.attributes.extension):t.push("file","lock")),e+" "+t.join("_")},this),this.switcherClass=ko.pureComputed(function(){var e=[];if(y.filetree.showLine?0===this.level()&&this.isFirstNode()&&this.isLastNode()?e.push("root"):0==this.level()&&this.isFirstNode()?e.push("roots"):this.isLastNode()?e.push("bottom"):e.push("center"):e.push("noline"),this.cdo.isFolder){var t=this.isExpanded()||!this.isExpanded()&&this.isSliding();e.push(t?"open":"close")}else e.push("docu");return e.join("_")},this),this.clusterClass=ko.pureComputed(function(){return y.filetree.showLine&&!this.isLastNode()?"line":""},this)}},n=function(){function o(e){return y.manager.selection.enabled&&y.manager.selection.useCtrlKey&&e.ctrlKey===!0?!1:y.manager.dblClickOpen&&"click"===e.type?!1:!0}var r=this;this.objects=ko.observableArray([]),this.objectsSize=ko.observable(0),this.objectsNumber=ko.observable(0),this.selectedNumber=ko.observable(0),this.listSortField=ko.observable(S),this.listSortOrder=ko.observable(_),this.isScrolling=ko.observable(!1),this.isDone=ko.observable(!0),this.isSelecting=ko.observable(!1),this.continiousSelection=ko.observable(!1),this.isSelecting.subscribe(function(e){e||r.continiousSelection(!1)}),this.createObject=function(e){return new n(e)},this.addNew=function(o){e.isArray(o)||(o=[o]),e.each(o,function(e,o){t.itemsModel.objects.push(r.createObject(o))}),t.itemsModel.sortObjects()},this.loadList=function(o,i){t.loadingFiles(!0);var r=t.itemsModel.objects().length;"/"!==o&&"split"!==y.options.filemanagerMode&&r--;var n={mode:"getfolder",path:o};typeof{}!=typeof i&&(i={}),E.param("type")&&(n.type=E.param("type"));var a={};t.currentPath()===o&&(a.skip=r),i.load&&"split"===y.options.filemanagerMode&&(a.load=i.load),e.ajax({type:"GET",url:fe(n),dataType:"json",data:a,cache:!1,success:function(e){e.data&&e.data.tree&&(t.itemsModel.isDone(e.data.done),t.currentPath()==o&&t.itemsModel.objects().length>0?t.itemsModel.extendList(e.data.tree):(t.currentPath(o),t.itemsModel.setList(e.data.tree)),t.currentPath(o),t.breadcrumbsModel.splitCurrent()),t.loadingFiles(!1),Y(e)},error:Q})},this.setList=function(i){var n=[];if(!J(t.currentPath())&&t.currentPath()!==C){var a=ae(t.currentPath()),s={id:a,rdo:{id:a,type:"parent",attributes:{readable:!0,writable:!0}}};s.open=function(e,t){o(t)&&r.loadList(s.id)},n.push(s)}e.each(i,function(e,t){n.push(r.createObject(t))}),t.itemsModel.objects(n),t.itemsModel.sortObjects(),t.loadingView(!1)},this.extendList=function(o){var i=[];e.each(o,function(e,t){i.push(r.createObject(t))}),ko.utils.arrayPushAll(t.itemsModel.objects(),i),t.itemsModel.sortObjects(),t.loadingView(!1)},this.findByParam=function(e,o){return ko.utils.arrayFirst(t.itemsModel.objects(),function(t){return t[e]===o})},this.findByFilter=function(e,t){var o=!t,i=[],n=r.objects();if(!n||0===n.length)return null;for(var a=0,s=n.length;s>a;a++)if(e(n[a])){if(o)return n[a];i.push(n[a])}return o?null:i},this.sortObjects=function(){var e=R(r.objects(),"split"===y.options.filemanagerMode?"folders":"");r.objects(e)},this.getSelected=function(){var e=r.findByFilter(function(e){return"parent"!==e.rdo.type&&e.selected()},!0);return r.selectedNumber(e.length),e},this.unselectItems=function(t){var o=y.manager.selection.enabled&&y.manager.selection.useCtrlKey&&t===!0;o||e.each(r.getSelected(),function(e,t){t.selected(!1)})},this.objects.subscribe(function(t){var o=0,i=0;e.each(t,function(e,t){"parent"!==t.rdo.type&&o++,"file"===t.rdo.type&&(i+=Number(t.rdo.attributes.size))}),r.objectsNumber(o),r.objectsSize($(i)),g.contextMenu({selector:".file, .directory",zIndex:100,build:function(t,o){var i=ko.dataFor(t[0]);return i.selected()||(F.itemsModel.unselectItems(!1),i.selected(!0)),{appendTo:".fm-container",items:s(i.rdo),callback:function(t,o){var r=[];e.each(F.itemsModel.getSelected(),function(e,t){r.push(t.rdo)}),Le(t,i.rdo,r)}}}})});var n=function(e){var t=y.viewer.image.thumbMaxWidth;e.attributes.width&&e.attributes.width<t&&(t=e.attributes.width),this.id=e.id,this.rdo=e,this.cdo={isFolder:"folder"===e.type,sizeFormatted:$(e.attributes.size),dimensions:e.attributes.width?e.attributes.width+"x"+e.attributes.height:null,cssItemClass:"folder"===e.type?"directory":"file",imageUrl:me(e,!0),previewWidth:t},this.visible=ko.observable(!0),this.selected=ko.observable(!1),this.title=ko.pureComputed(function(){return y.options.showTitleAttr?this.rdo.id:null},this),this.itemClass=ko.pureComputed(function(){var e=[];return this.selected()&&y.manager.selection.enabled&&e.push("ui-selected"),this.cdo.cssItemClass+" "+e.join(" ")},this),this.listIconClass=ko.pureComputed(function(){var e,t=["ico"];return this.cdo.isFolder===!0?(e="ico_folder",t.push("folder"),this.rdo.attributes.readable||t.push("lock")):(e="ico_file",this.rdo.attributes.readable?t.push("ext",this.rdo.attributes.extension):t.push("file","lock")),e+" "+t.join("_")},this),this.gridIconClass=ko.pureComputed(function(){var e=[],t=["ico"];return this.cdo.imageUrl||(e.push("grid-icon"),this.cdo.isFolder===!0?(e.push("ico_folder"),t.push("folder"),this.rdo.attributes.readable||t.push("lock")):(e.push("ico_file"),this.rdo.attributes.readable?t.push("ext",this.rdo.attributes.extension):t.push("file","lock")),e.push(t.join("_"))),e.join(" ")},this),this.open=function(e,t){var n=this;r.unselectItems(t.ctrlKey),n.selected(!n.selected()),o(t)&&(y.options.quickSelect&&"file"===n.rdo.type&&i(n.rdo,"select")?ye(n.rdo):Ie(n.rdo))},this.remove=function(){r.objects.remove(this)}};this.onCustomScrolling=function(e){e>=N&&!0!==t.itemsModel.isDone()&&t.itemsModel.loadList(t.currentPath(),{load:2})}},l=function(){var e=function(e){var o=this;this.column=ko.observable(e),this.order=ko.observable(t.itemsModel.listSortOrder()),this.sortClass=ko.pureComputed(function(){var e;return t.itemsModel.listSortField()===o.column()&&(e="sorted sorted-"+this.order()),e},this),this.sort=function(){var e="asc"===o.order(),i=t.itemsModel.listSortField()===o.column();o.order(i?e?"desc":"asc":t.itemsModel.listSortOrder()),t.itemsModel.listSortField(o.column()),t.itemsModel.listSortOrder(o.order()),t.itemsModel.sortObjects()}};this.thName=new e("name"),this.thType=new e("type"),this.thSize=new e("size"),this.thDimensions=new e("dimensions"),this.thModified=new e("modified")},c=function(){this.closeButton=ko.observable(!1),this.closeButtonOnClick=function(){console.log("clicked")},this.goHome=function(){t.previewFile(!1),t.itemsModel.loadList(C)},this.goParent=function(){var e=t.previewFile()?ne(t.previewModel.rdo().id):ae(t.currentPath());t.previewFile()&&t.previewFile(!1),e!==t.currentPath()&&t.itemsModel.loadList(e)},this.displayGrid=function(){t.viewMode("grid"),t.previewFile(!1)},this.displayList=function(){t.viewMode("list"),t.previewFile(!1)},this.createFolder=function(){var t=function(t,o){var i=o.getInputValue();return i?(i=K(i),void e.ajax({type:"GET",url:fe({mode:"addfolder",path:F.currentPath(),name:i}),dataType:"json",success:function(e){e.data&&(F.addItem(e.data,F.currentPath()),o.closeDialog(),y.options.showConfirmation&&d.success(M.successful_added_folder)),Y(e)},error:Q})):void d.error(M.no_foldername)};d.prompt({message:M.prompt_foldername,value:M.default_foldername,okBtn:{label:M.create_folder,autoClose:!1,click:t},cancelBtn:{label:M.cancel}})}},u=function(){this.files=ko.observable(null),this.folders=ko.observable(null),this.size=ko.observable(null),this.enabled=ko.observable(!1),this.doSummarize=function(){Ee()}},p=function(){var o=this;this.value=ko.observable(""),this.findAll=function(i,r){var n=200,a=!0;o.value(r.target.value),ve(function(){var i=a?o.value().toLowerCase():o.value();e.each(t.itemsModel.objects(),function(e,t){if("parent"!==t.rdo.type){var o=t.rdo.attributes.name;a&&(o=o.toLowerCase());var r=0===o.indexOf(i);t.visible(r)}})},n)},this.reset=function(i,r){o.value(""),e.each(t.itemsModel.objects(),function(e,t){t.visible(!0)})}},f=function(){function e(){o=[],i=null}var o=[],i=null,r=this,n=j.indexOf("copy")>-1||j.indexOf("move")>-1;this.enabled=ko.observable(t.config().options.clipboard&&n),this.copy=function(){r.hasCapability("copy")&&(i="copy",o=t.itemsModel.getSelected())},this.cut=function(){r.hasCapability("cut")&&(i="cut",o=t.itemsModel.getSelected())},this.paste=function(){if(r.hasCapability("paste")){if(null===i||0===o.length)return void d.warning(M.clipboard_empty);var n=t.currentPath();ge(o,function(e,t){return"cut"===i?je(t,n):"copy"===i?ke(t,n):void 0},e)}},this.clear=function(){r.hasCapability("clear")&&(e(),d.success(M.clipboard_cleared))},this.isEmpty=function(){return 0===o.length},this.hasCapability=function(e){if(!r.enabled)return!1;switch(e){case"copy":return j.indexOf("copy")>-1;case"cut":return j.indexOf("move")>-1;default:return!0}}},h=function(){var e=this;this.items=ko.observableArray([]),this.add=function(t,i){e.items.unshift(new o(t,i))},this.splitCurrent=function(){var o=t.currentPath().split("/");for(e.items([]);o.length>0;){var i=o.pop();if(i){var r=o.slice(0);r.push(i,""),e.add(r.join("/"),i)}}e.add(C,"")};var o=function(e,o){var i=this;this.path=e,this.label=o,this.isRoot=e===C,this.active=e===t.currentPath(),this.itemClass=function(){var e=["nav-item"];return i.isRoot&&e.push("root"),i.active&&e.push("active"),e.join(" ")},this["goto"]=function(e,o){e.active||t.itemsModel.loadList(e.path)}};e.add(C,"")};this.treeModel=new r,this.itemsModel=new n,this.tableViewModel=new l,this.previewModel=new o,this.headerModel=new c,this.summaryModel=new u,this.searchModel=new p,this.clipboardModel=new f,this.breadcrumbsModel=new h},R=function(e,t){function o(e){var t,o=S;switch("list"===F.viewMode()&&(o=F.itemsModel.listSortField()),o){case"type":t=e.rdo.attributes.extension||"";break;case"size":t=e.rdo.attributes.size;break;case"modified":t=e.rdo.attributes.timestamp;break;case"dimensions":t=e.cdo.dimensions||"";break;default:t=e.rdo.attributes.name}return"string"==typeof t&&(s.cases||(t=t.toLowerCase()),t=t.replace(/\s+/g," ")),t}function i(e,t){for(var o=r(e.toString()),i=r(t.toString()),n=0;o[n]&&i[n];n++)if(o[n]!==i[n]){var a=Number(o[n]),s=Number(i[n]);return a==o[n]&&s==i[n]?a-s:o[n]>i[n]?1:-1}return o.length-i.length}function r(e){for(var t,o,i=[],r=0,n=-1,a=0;t=(o=e.charAt(r++)).charCodeAt(0);){var s=46==t||t>=48&&57>=t;s!==a&&(i[++n]="",a=s),i[n]+=o;
}return i}for(var n,a="list"===F.viewMode()?F.itemsModel.listSortOrder():_,s={natural:!0,order:"asc"===a?1:-1,cases:!1},l=[],d=e.length;d--;)"folder"===e[d].rdo.type?(l.push(e[d]),e.splice(d,1)):"parent"===e[d].rdo.type&&(n=e.splice(d,1)[0]);switch(l.reverse(),t){case"folders":break;case"files":e=l;break;default:"top"!==y.options.folderPosition&&l.reverse();for(var c=0,u=l.length;u>c;c++)"top"===y.options.folderPosition?e.unshift(l[c]):e.push(l[c]);n&&e.unshift(n)}return k&&e.sort(function(e,t){if("parent"===e.rdo.type||"parent"===t.rdo.type)return-1;var r,n=o(e),a=o(t);return r=n===a?0:void 0===n||void 0===a?0:s.natural&&(isNaN(n)||isNaN(a))?i(n,a):a>n?-1:n>a?1:0,r*=s.order}),e},W=function(t){return e.ajax({type:"HEAD",url:t})},G=function(t){var o=null;return t="undefined"==typeof t?"user":t,o="user"===t?E.param("config")?d.settings.baseUrl+d.settings.config.url+E.param("config"):d.settings.baseUrl+d.settings.config.url+"filemanager.config.json":d.settings.baseUrl+d.settings.config.url+"filemanager.config.default.json",e.ajax({type:"GET",url:o,dataType:"json",cache:!1,error:function(e){d.error("Given config file ("+o+") does not exist!")}})},H=function(e){for(var t=0,o=e.length;o>t;t++)"string"==typeof e[t]&&(e[t]=d.settings.baseUrl+e[t]);toast.apply(this,e)},q=function(t,o){return e.ajax({type:"GET",url:d.settings.baseUrl+y.paths.templates+t+".html",error:Q})},K=function(e,t){if(y.security.normalizeFilename){var o={" ":"_","'":"_","/":"","\\":""};e=e.replace(/[\s\S]/g,function(e){return o[e]||e})}return y.options.charsLatinOnly&&("undefined"==typeof t&&(t=[]),e=getSlug(e,{separator:"_",maintainCase:!0,custom:t}),e=e.replace(/[^_a-zA-Z0-9]/g,"")),e=e.replace(/[_]+/g,"_")},V=function(e){var t="";return-1!=e.lastIndexOf(".")?(t=K(e.substr(0,e.lastIndexOf("."))),t+="."+e.split(".").pop()):t=K(e),t},$=function(e,t){if(!e)return"";t=t||!1;for(var o=parseFloat(e),i=parseFloat(t?1e3:1024),r=0,n=[M.unit_bytes,M.unit_kb,M.unit_mb,M.unit_gb];;){if(i>o)return o=Math.round(100*o)/100,o+" "+n[r];o/=i,r+=1}},Q=function(e){y.options.logger&&console.log(e.responseText||e),d.error(M.ERROR_SERVER),d.error(e.responseText)},Y=function(t){t.errors&&e.each(t.errors,function(e,t){d.error(t.title)})},Z=function(t){var o=ie(t);return""===o&&y.security.allowNoExtension===!0?!0:"DISALLOW_ALL"==y.upload.policy&&-1!==e.inArray(o,y.upload.restrictions)?!0:"ALLOW_ALL"==y.upload.policy&&-1===e.inArray(o,y.upload.restrictions)?!0:!1},J=function(e){return"/"!==e.charAt(e.length-1)},X=function(e,t){var o=new RegExp("^"+t+"+|"+t+"+$","g");return e.replace(o,"")},ee=function(e,t){var o=new RegExp(t+"+$","g");return e.replace(o,"")},te=function(t){var o=[];return e.each(t.split("/"),function(e,t){o.push(encodeURIComponent(t))}),o.join("/")},oe=function(e){return e.replace(/\\/g,"/").replace(/\/+/g,"/")},ie=function(e){return 1===e.split(".").length?"":e.split(".").pop().toLowerCase()},re=function(e){return-1!==e.lastIndexOf(".")?e.substring(0,e.lastIndexOf(".")):e},ne=function(e){return e.lastIndexOf("/")!==e.length-1?e.substr(0,e.lastIndexOf("/")+1):e},ae=function(e){return e.split("/").reverse().slice(2).reverse().join("/")+"/"},se=function(t){return-1!==e.inArray(ie(t),y.viewer.editable.extensions)},le=function(t){return-1!==e.inArray(ie(t),y.viewer.image.extensions)},de=function(t){return-1!==e.inArray(ie(t),y.viewer.video.extensions)},ce=function(t){return-1!==e.inArray(ie(t),y.viewer.audio.extensions)},ue=function(t){return-1!==e.inArray(ie(t),y.viewer.opendoc.extensions)},pe=function(t){return-1!==e.inArray(ie(t),y.viewer.google.extensions)},fe=function(t){var o={time:(new Date).getTime()},i=e.extend({},t||{},o);return x+"?"+e.param(i)},he=function(e,t){t=t||!1;var o,i=e.attributes.path;return y.viewer.absolutePath&&i?(t&&(i=te(i)),o=be(i)):o=fe({mode:"readfile",path:e.id}),o=d.settings.callbacks.beforeCreatePreviewUrl(e,o)},me=function(e,t){var o;if(le(e.id)&&e.attributes.readable&&(t&&y.viewer.image.showThumbs||!t&&y.viewer.image.enabled===!0)){if(y.viewer.absolutePath&&!t&&e.attributes.path)o=be(te(e.attributes.path));else if(y.viewer.image.thumbPathRules){o=e.attributes.path;for(var i in y.viewer.image.thumbPathRules){var r=RegExp(i);o=o.replace(r,y.viewer.image.thumbPathRules[i])}}else{var n={path:e.id};"svg"===e.attributes.extension?n.mode="readfile":(n.mode="getimage",t&&(n.thumbnail="true")),o=fe(n)}o=d.settings.callbacks.beforeCreateImageUrl(e,o)}return o},be=function(e){var t="string"==typeof y.viewer.previewUrl?y.viewer.previewUrl:location.origin;return X(t,"/")+e+"?time="+(new Date).getTime()},ve=function(){var e=0;return function(t,o){clearTimeout(e),e=setTimeout(t,o)}}(),ge=function(t,o,i){var r=0,n=t.length,a=e.Deferred().resolve();e.each(t,function(e,t){a=a.then(function(){return o(e,t)}).then(function(e){e&&e.data&&r++})}),n>1&&a.then(function(){d.log(M.successful_processed.replace("%s",r).replace("%s",n))}),a.then(function(){"function"==typeof i&&i()})},we=function(){if(document.selection&&document.selection.empty)document.selection.empty();else if(window.getSelection){var e=window.getSelection();e.removeAllRanges()}},ye=function(e){var t=null,o=he(e,!0);if(o=d.settings.callbacks.beforeSelectItem(e,o),window.tinyMCEPopup){var i=tinyMCEPopup.getWindowArg("window");return i.document.getElementById(tinyMCEPopup.getWindowArg("input")).value=o,"undefined"!=typeof i.ImageDialog&&(i.ImageDialog.getImageData&&i.ImageDialog.getImageData(),i.ImageDialog.showPreviewImage&&i.ImageDialog.showPreviewImage(o)),void tinyMCEPopup.close()}if(E.param("field_name")&&(parent.document.getElementById(E.param("field_name")).value=o,"undefined"!=typeof parent.tinyMCE&&parent.tinyMCE.activeEditor.windowManager.close(),"undefined"!=typeof parent.$.fn.colorbox&&parent.$.fn.colorbox.close()),E.param("ImperaviElementId"))if(window.opener);else{var r=E.param("ImperaviElementId"),n=parent.$("#"+r).redactor("core.getObject");n&&(n.modal.close(),n.buffer.set(),le(e.attributes.name)?n.insert.html('<img src="'+o+'">'):n.insert.html('<a href="'+o+'">'+e.attributes.name+"</a>"))}if(E.param("CKEditor")&&(window.opener?window.opener.CKEDITOR.tools.callFunction(E.param("CKEditorFuncNum"),o):(parent.CKEDITOR.tools.callFunction(E.param("CKEditorFuncNum"),o),parent.CKEDITOR.tools.callFunction(E.param("CKEditorCleanUpFuncNum")))),window.opener&&"function"==typeof window.opener.SetUrl)if(e.attributes.width){var a=o,s=e.attributes.width,l=e.attributes.height;window.opener.SetUrl(a,s,l)}else window.opener.SetUrl(o);window.opener&&(t=window.opener),window.parent&&window.self!==window.parent&&(t=window.parent),t&&t.postMessage({source:"richfilemanager",preview_url:o},"*"),d.settings.callbacks.afterSelectItem(e,o,t)},Me=function(t){var o=function(o,i){var r=t.id,n=i.getInputValue();if(!n)return void d.error(M.new_filename);if(!y.security.allowChangeExtensions){n=V(n);var a=ie(t.attributes.name);a.length>0&&(n=n+"."+a)}if(J(r)&&!Z(n)){var s="<p>"+M.INVALID_FILE_TYPE+"</p>";return"DISALLOW_ALL"==y.upload.policy&&(s+="<p>"+M.ALLOWED_FILE_TYPE+y.upload.restrictions.join(", ")+".</p>"),"ALLOW_ALL"==y.upload.policy&&(s+="<p>"+M.DISALLOWED_FILE_TYPE+y.upload.restrictions.join(", ")+".</p>"),e("#filepath").val(""),void d.error(s)}e.ajax({type:"GET",url:fe({mode:"rename",old:r,"new":n}),dataType:"json",success:function(e){if(e.data){var t=e.data,o=F.treeModel.findByParam("id",r);if(o&&("folder"===o.rdo.type&&(o.nodeTitle(t.attributes.name),F.treeModel.actualizeNodeObject(o,r,t.id)),"file"===o.rdo.type)){var n=o.parentNode(),a=F.treeModel.createNode(t);o.remove(),n&&F.treeModel.addNodes(n,a)}var s=F.itemsModel.findByParam("id",r);s&&("parent"===s.rdo.type?s.id=t.id:(s.remove(),F.itemsModel.addNew(t))),F.currentPath()===r&&F.itemsModel.loadList(t.id),F.previewFile()&&F.previewModel.rdo().id===r&&F.previewModel.load(t),i.closeDialog(),y.options.showConfirmation&&d.success(M.successful_rename)}Y(e)},error:Q})};d.prompt({message:M.new_filename,value:y.security.allowChangeExtensions?t.attributes.name:re(t.attributes.name),okBtn:{label:M.action_rename,autoClose:!1,click:o},cancelBtn:{label:M.cancel}})},Ce=function(t){var o=e("#fm-js-preview-toolbar"),i=o.find(":file");"undefined"==typeof o.data("blueimpFileupload")&&o.fileupload({autoUpload:!0,dataType:"json",url:fe(),paramName:y.upload.paramName}).on("fileuploadadd",function(e,o){var i=o.files[0];return ie(i.name)!=t.attributes.extension?(d.error(M.ERROR_REPLACING_FILE+" ."+t.attributes.extension),!1):void o.submit()}).on("fileuploadsubmit",function(e,o){o.formData={mode:"replace",path:t.id},w.addClass("loading").prop("disabled",!0),w.children("span").text(M.loading_data)}).on("fileuploadalways",function(e,t){w.removeData().removeClass("loading").prop("disabled",!1),w.children("span").text(M.action_upload);var o=t.result;if(o&&o.errors&&d.error(M.upload_failed+"<br>"+o.errors[0].title),o&&o.data){var i=o.data[0];F.removeItem(i),F.addItem(i,F.currentPath()),F.previewFile()&&F.previewModel.load(i),y.options.showConfirmation&&d.success(M.successful_replace)}}).on("fileuploadchunkdone",function(e,t){var o=t.result;if(o.data&&o.data[0]){var i=o.data[0];F.removeItem(i),F.addItem(i,F.currentPath())}}).on("fileuploadfail",function(e,t){d.error(M.upload_failed)}),i.click()},xe=function(e,t){var o=function(e,o){var i=o.getInputValue();return i?(i=ee(i,"/")+"/",void t(i)):void d.error(M.prompt_foldername)},i=e.length,r=i>1?M.prompt_move_multiple.replace("%s",i):M.prompt_move;d.prompt({message:r,value:F.currentPath(),okBtn:{label:M.action_move,autoClose:!1,click:o},cancelBtn:{label:M.cancel},template:{dialogInput:'<input data-alertify-input type="text" value="" /><div class="prompt-info">'+M.help_move+"</div>"}})},ke=function(t,o){return e.ajax({type:"GET",url:fe({mode:"copy",source:t.id,target:o}),dataType:"json",success:function(e){if(e.data){var t=e.data;F.addItem(t,o),alertify.clearDialogs(),y.options.showConfirmation&&d.success(M.successful_copied)}Y(e)},error:Q})},je=function(t,o){return e.ajax({type:"GET",url:fe({mode:"move",old:t.id,"new":o}),dataType:"json",success:function(e){if(e.data){var i=e.data;F.removeItem(t),F.addItem(i,o),F.currentPath()===t.id&&F.itemsModel.loadList(i.id),F.previewFile()&&F.previewModel.rdo().id===t.id&&F.previewFile(!1),alertify.clearDialogs(),y.options.showConfirmation&&d.success(M.successful_moved)}Y(e)},error:Q})},Se=function(e,t){var o=e.length,i=o>1?M.confirm_delete_multiple.replace("%s",o):M.confirm_delete;d.confirm({message:i,okBtn:{label:M.yes,click:function(e,o){t()}},cancelBtn:{label:M.no}})},_e=function(t){return e.ajax({type:"GET",url:fe({mode:"delete",path:t}),dataType:"json",success:function(e){if(e.data){var t=e.data;F.removeItem(t),F.previewFile()&&F.previewModel.rdo().id===t.id&&F.previewFile(!1),y.options.showConfirmation&&d.success(M.successful_delete)}Y(e)},error:Q})},Fe=function(t){var o={mode:"download",path:t.id};return e.ajax({type:"GET",url:fe(o),dataType:"json",success:function(t){t.data&&e.fileDownload(fe(o)),Y(t)},error:Q})},Ne=function(t){e.ajax({type:"GET",url:fe({mode:"editfile",path:t.id}),dataType:"json",success:function(e){e.data&&(F.previewModel.editor.enabled(!0),F.previewModel.editor.content(e.data.attributes.content),Pe(t.attributes.extension)),Y(e)},error:Q})},Oe=function(t){var o=F.previewModel.editor.codeMirror().getValue();F.previewModel.editor.content(o),e.ajax({type:"POST",url:fe(),dataType:"json",data:e("#fm-js-editor-form").serializeArray(),success:function(e){if(e.data){var t=e.data;F.previewModel.editor.enabled(!1),F.previewModel.load(t);var o=F.itemsModel.createObject(t),i=F.itemsModel.findByParam("id",t.id);F.itemsModel.objects.replace(i,o),d.success(M.successful_edit)}Y(e)},error:Q})},Ee=function(){e.ajax({type:"GET",url:fe({mode:"summarize"}),dataType:"json",success:function(t){if(t.data){var o=t.data.attributes,i=$(o.size,!0);if(o.sizeLimit>0){var r=$(o.sizeLimit,!0),n=100*o.size/o.sizeLimit,a=Math.round(100*n)/100;i+=" ("+a+"%) "+M.of+" "+r}F.summaryModel.files(o.files),F.summaryModel.folders(o.folders),F.summaryModel.size(i),F.summaryModel.enabled(!0);var s=e("#summary-popup").clone().show();F.summaryModel.enabled(!1),d.alert(s[0].outerHTML)}Y(t)},error:Q})},Ie=function(e){return e.attributes.readable?("file"===e.type&&F.previewModel.load(e),void(("folder"===e.type||"parent"===e.type)&&F.itemsModel.loadList(e.id))):(d.error(M.NOT_ALLOWED_SYSTEM),!1)},Le=function(t,o,i){var r=i?i:[o];switch(t){case"select":ye(o);break;case"download":e.each(r,function(e,t){Fe(t)});break;case"rename":Me(o);break;case"replace":Ce(o);break;case"move":xe(r,function(e){ge(r,function(t,o){return je(o,e)})});break;case"delete":Se(r,function(){ge(r,function(e,t){return _e(t.id)})});break;case"copy":F.clipboardModel.copy();break;case"cut":F.clipboardModel.cut()}},Te=function(){return y.options.browseOnly?!1:void(y.upload.multiple?(e("#file-input-container").remove(),w.unbind().click(function(){if(-1===j.indexOf("upload"))return d.error(M.NOT_ALLOWED),!1;var t=null,o=F.currentPath(),i=tmpl("tmpl-fileupload-container",{folder:M.current_folder+o,info:M.upload_files_number_limit.replace("%s",y.upload.maxNumberOfFiles)+" "+M.upload_file_size_limit+$(y.upload.fileSizeLimit,!0),lang:M});"DISALLOW_ALL"==y.upload.policy&&(t=new RegExp("(\\.|\\/)("+y.upload.restrictions.join("|")+")$","i")),d.dialog({message:i,width:"auto",buttons:[{type:"ok",label:M.action_upload,autoClose:!1,click:function(e,t){n.children(".upload-item").length>0?n.find(".button-start").trigger("click"):d.error(M.upload_choose_file)}},{label:M.action_select,closeOnClick:!1,click:function(t,o){e("#fileupload",r).trigger("click")}},{type:"cancel",label:M.close}]});var r=e(".fm-fileupload-container"),n=e(".dropzone",r),a=e(".dropzone-wrapper",r),s=e("#total-progress",r).children();y.customScrollbar.enabled&&a.mCustomScrollbar({theme:y.customScrollbar.theme,scrollButtons:{enable:y.customScrollbar.button},advanced:{autoExpandHorizontalScroll:!0,updateOnContentResize:!0},callbacks:{onOverflowY:function(){a.find(".mCSB_container").css({"margin-right":a.find(".mCSB_scrollTools").width()})},onOverflowYNone:function(){a.find(".mCSB_container").css({"margin-right":"auto"})}},axis:"y"}),a.on("click",function(t){(t.target===this||e(t.target).parent()[0]===this||t.target===n[0]||e(t.target).parent().hasClass("default-message"))&&e("#fileupload",r).trigger("click")}),n.on("click",".button-start",function(t){var o=e(this),i=o.parent().parent(),r=i.data();r.submit(),o.remove()}),n.on("click",".button-abort",function(t){var o=e(this),i=o.parent().parent(),r=i.data(),n=r.files[0].context;r.abort(),n.find(".error-message").text(M.upload_aborted),n.addClass("aborted")}),n.on("click",".button-resume",function(t){function i(o){e.blueimp.fileupload.prototype.options.add.call(e("#fileupload")[0],t,o),o.submit()}var r=e(this),n=r.parent().parent(),a=n.data(),s=a.files[0];s.chunkUploaded?e.ajax({type:"GET",url:fe({mode:"getfile",path:o+s.serverName}),dataType:"json",success:function(e){e.data&&(a.uploadedBytes=Number(e.data.attributes.size),a.uploadedBytes||(s.chunkUploaded=void 0),i(a)),Y(e)},error:Q}):i(a)}),n.on("click",".button-remove",function(t){var i=e(this),r=i.parent().parent(),n=r.data(),a=n.files[0];a.chunkUploaded&&_e(o+a.serverName),i.closest(".upload-item").remove(),l()}),n.on("click",".button-info",function(t){var o=e(this),i=o.closest(".upload-item");if(i.hasClass("error")){var r=i.find(".error-message");d.error(r.text())}});var l=function(){n.children(".upload-item").length>0?n.addClass("started"):n.removeClass("started")};e("#fileupload",r).fileupload({autoUpload:!1,sequentialUploads:!0,dataType:"json",dropZone:n,maxChunkSize:y.upload.chunkSize,url:fe(),paramName:y.upload.paramName,singleFileUploads:!0,formData:{mode:"upload",path:o},maxNumberOfFiles:y.upload.maxNumberOfFiles,acceptFileTypes:t,maxFileSize:y.upload.fileSizeLimit,messages:{maxNumberOfFiles:M.upload_files_number_limit.replace("%s",y.upload.maxNumberOfFiles),acceptFileTypes:M.upload_file_type_invalid,maxFileSize:M.upload_file_too_big+" "+M.upload_file_size_limit+$(y.upload.fileSizeLimit,!0)},previewMaxHeight:120,previewMaxWidth:120,previewCrop:!0}).on("fileuploadadd",function(t,o){var i=n.children(".upload-item");e.each(o.files,function(t,r){if(i.length>=y.upload.maxNumberOfFiles)return d.error(M.upload_files_number_limit.replace("%s",y.upload.maxNumberOfFiles),{logClass:"fileuploadadd",unique:!0}),!1;r.formattedSize=$(r.size);var a=e(tmpl("tmpl-upload-item",{file:r,lang:M,imagesPath:d.settings.baseUrl+y.paths.images}));r.context=a,a.find(".buttons").data(o),a.appendTo(n)}),l()}).on("fileuploadsend",function(t,o){e.each(o.files,function(e,t){var i=t.context;i.removeClass("added aborted error").addClass("process"),t.chunkUploaded&&o.total===o.uploadedBytes&&i.remove()})}).on("fileuploadfail",function(t,o){e.each(o.files,function(e,t){t.error=M.upload_failed;var o=t.context;o.removeClass("added process").addClass("error")})}).on("fileuploaddone",function(t,o){var i=o.result;e.each(o.files,function(e,t){var o=t.context;i&&i.errors?(o.removeClass("added process").addClass("error"),o.find(".error-message").text(i.errors[0].title),o.find(".button-start").remove()):o.remove()})}).on("fileuploadalways",function(t,o){var i=o.result;e.each(o.files,function(e,t){if(i&&i.data&&i.data[e]){var o=i.data[e];F.removeItem(o),F.addItem(o,F.currentPath())}});var r=n.children(".upload-item");0===r.filter(".added").length&&0===r.filter(".process").length&&(0===r.length&&(alertify.clearDialogs(),y.options.showConfirmation&&d.success(M.upload_successful_files)),r.filter(".error").length&&d.error(M.upload_partially+"<br>"+M.upload_failed_details)),l()}).on("fileuploadchunkdone",function(t,o){var i=o.result;e.each(o.files,function(e,t){if(i.data&&i.data[e]){var o=i.data[e];F.removeItem(o),F.addItem(o,F.currentPath()),t.serverName=o.attributes.name,t.chunkUploaded=1}})}).on("fileuploadprocessalways",function(t,o){e.each(o.files,function(e,t){var o=t.context;"undefined"!=typeof o&&(t.preview&&(o.find(".image").append(t.preview),o.find(".preview").removeClass("file-preview").addClass("image-preview")),t.error&&(o.removeClass("added process").addClass("error"),o.find(".error-message").text(t.error),o.find(".button-start").remove()))})}).on("fileuploadprogress",function(t,o){e.each(o.files,function(e,t){var i=t.context,r=parseInt(o.loaded/o.total*100,10);i.find(".progress-bar").css("width",r+"%")})}).on("fileuploadprogressall",function(e,t){var o=parseInt(t.loaded/t.total*100,10);s.css("width",o+"%")})})):(w.click(function(){if(-1===j.indexOf("upload"))return d.error(M.NOT_ALLOWED),!1;var t=e(this).data();e.isEmptyObject(t)?d.error(M.upload_choose_file):t.submit()}),f.fileupload({autoUpload:!1,dataType:"json",url:fe(),paramName:y.upload.paramName,maxChunkSize:y.upload.chunkSize}).on("fileuploadadd",function(e,t){w.data(t)}).on("fileuploadsubmit",function(e,t){t.formData={mode:"upload",path:F.currentPath()},w.addClass("loading").prop("disabled",!0),w.children("span").text(M.loading_data)}).on("fileuploadalways",function(t,o){e("#filepath").val(""),w.removeData().removeClass("loading").prop("disabled",!1),w.children("span").text(M.action_upload);var i=o.result;if(i&&i.errors&&d.error(M.upload_failed+"<br>"+i.errors[0].title),i&&i.data){var r=i.data[0];F.removeItem(r),F.addItem(r,F.currentPath()),y.options.showConfirmation&&d.success(M.upload_successful_file)}}).on("fileuploadchunkdone",function(e,t){var o=t.result;if(o.data&&o.data[0]){var i=o.data[0];F.removeItem(i),F.addItem(i,F.currentPath())}}).on("fileuploadfail",function(e,t){d.error(M.upload_failed)})))},Pe=function(e){function t(){var e=CodeMirror.fromTextArea(document.getElementById("fm-js-editor-content"),{styleActiveLine:!0,viewportMargin:1/0,lineNumbers:y.viewer.editable.lineNumbers,lineWrapping:y.viewer.editable.lineWrapping,theme:y.viewer.editable.theme,extraKeys:{F11:function(e){e.setOption("fullScreen",!e.getOption("fullScreen"))},Esc:function(e){e.getOption("fullScreen")&&e.setOption("fullScreen",!1)}}});e.setOption("mode",o),F.previewModel.editor.codeMirror(e)}var o,i=[];y.viewer.editable.codeHighlight?("txt"===e&&(o="default"),"js"===e&&(i.push(y.paths.scripts+"CodeMirror/mode/javascript/javascript.js"),o="javascript"),"css"===e&&(i.push(y.paths.scripts+"CodeMirror/mode/css/css.js"),o="css"),"html"===e&&(i.push(y.paths.scripts+"CodeMirror/mode/xml/xml.js"),o="text/html"),"xml"===e&&(i.push(y.paths.scripts+"CodeMirror/mode/xml/xml.js"),o="application/xml"),"php"===e&&(i.push(y.paths.scripts+"CodeMirror/mode/htmlmixed/htmlmixed.js"),i.push(y.paths.scripts+"CodeMirror/mode/xml/xml.js"),i.push(y.paths.scripts+"CodeMirror/mode/javascript/javascript.js"),i.push(y.paths.scripts+"CodeMirror/mode/css/css.js"),i.push(y.paths.scripts+"CodeMirror/mode/clike/clike.js"),i.push(y.paths.scripts+"CodeMirror/mode/php/php.js"),o="application/x-httpd-php"),"sql"===e&&(i.push(y.paths.scripts+"CodeMirror/mode/sql/sql.js"),o="text/x-mysql"),"md"===e&&(i.push(y.paths.scripts+"CodeMirror/addon/mode/overlay.js"),i.push(y.paths.scripts+"CodeMirror/mode/xml/xml.js"),i.push(y.paths.scripts+"CodeMirror/mode/markdown/markdown.js"),i.push(y.paths.scripts+"CodeMirror/mode/gfm/gfm.js"),i.push(y.paths.scripts+"CodeMirror/mode/javascript/javascript.js"),i.push(y.paths.scripts+"CodeMirror/mode/css/css.js"),i.push(y.paths.scripts+"CodeMirror/mode/htmlmixed/htmlmixed.js"),i.push(y.paths.scripts+"CodeMirror/mode/clike/clike.js"),i.push(y.paths.scripts+"CodeMirror/mode/meta.js"),o="gfm")):o="default",i.length?(i.push(t),H(i)):t()};L(),e(window).resize(d.setDimensions)}}(jQuery),$.fn.richFilemanager=function(e){return this.each(function(){if(void 0==$(this).data("richFilemanager")){var t=new $.richFilemanagerPlugin(this,e);$(this).data("richFilemanager",t)}})},window.location.origin||(window.location.origin=window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:""));