!function(e){e.richFilemanagerPlugin=function(t,i){function r(t,i){if(-1===S.indexOf(i))return!1;if("select"===i&&"folder"===t.type)return!1;if("extract"===i){var r=ae(t.attributes.name);return"file"===t.type&&"zip"===r}return"download"===i&&"folder"===t.type?!0===k.options.allowFolderDownload:void 0===t.attributes.capabilities||e.inArray(i,t.attributes.capabilities)>-1}function n(){k.filetree.enabled&&(b.show(),h.splitter({sizeLeft:k.filetree.width,minLeft:k.filetree.minWidth,minRight:200}))}function o(){return window.opener||window.parent&&window.self!==window.parent||window.tinyMCEPopup||N.param("field_name")||N.param("CKEditor")||N.param("ImperaviElementId")}function s(e){if(!e.attributes.readable)return d.error(W("NOT_ALLOWED_SYSTEM")),!1;"file"===e.type&&_.previewModel.applyObject(e),"folder"!==e.type&&"parent"!==e.type||(_.previewFile(!1),_.itemsModel.loadDataList(e.id))}function a(e){var t=!_.clipboardModel.enabled(),i={select:{name:W("action_select"),className:"select"},download:{name:W("action_download"),className:"download"},rename:{name:W("action_rename"),className:"rename"},move:{name:W("action_move"),className:"move"},separator1:"-----",copy:{name:W("clipboard_copy"),className:"copy"},cut:{name:W("clipboard_cut"),className:"cut"},delete:{name:W("action_delete"),className:"delete"},extract:{name:W("action_extract"),className:"extract"},copyUrl:{name:W("copy_to_clipboard"),className:"copy-url"}};return r(e,"download")||delete i.download,r(e,"select")&&o()||delete i.select,r(e,"rename")&&!0!==k.options.browseOnly||delete i.rename,r(e,"delete")&&!0!==k.options.browseOnly||delete i.delete,r(e,"extract")&&!0!==k.options.browseOnly||delete i.extract,r(e,"copy")&&!0!==k.options.browseOnly&&!t||delete i.copy,r(e,"move")&&!0!==k.options.browseOnly&&!t||(delete i.cut,delete i.move),i}var l={baseUrl:".",config:{},callbacks:{beforeCreateImageUrl:function(e,t){return t},beforeCreatePreviewUrl:function(e,t){return t},beforeSelectItem:function(e,t){return t},afterSelectItem:function(e,t,i){},beforeSetRequestParams:function(e,t){return t},beforeSendRequest:function(e,t){return!0}}},d=this,c=e(t),u=c.children(".fm-wrapper"),p=u.find(".fm-header"),f=p.find(".fm-uploader"),h=u.children(".fm-splitter"),m=u.children(".fm-footer"),v=h.children(".fm-fileinfo"),b=h.children(".fm-filetree"),g=v.find(".view-items-wrapper"),w=v.find(".fm-preview-wrapper"),y=g.find(".view-items"),M=f.children(".fm-upload"),k=null,C="/",x=null,S=[],j=null,L=null,_=null,E=null,O=null,I=null,N=purl(),T=(new Date).getTime();d.settings=e.extend(!0,l,i),d.write=function(t,i){var r=alertify,n=e.extend({},{reset:!0,delay:5e3,logMaxItems:5,logPosition:"bottom right",logContainerClass:"fm-log",logMessageTemplate:null,parent:document.body,onClick:void 0,unique:!1,type:"log"},i);if(n.logClass&&n.unique&&e(".fm-log").children("."+n.logClass).length>0)return r;n.reset&&r.reset(),r.parent(n.parent),r.logDelay(n.delay),r.logMaxItems(n.logMaxItems),r.logPosition(n.logPosition),r.logContainerClass(n.logContainerClass),r.logMessageTemplate(n.logMessageTemplate),r[n.type](t,n.onClick);var o=r.getLogs();return o[o.length-1]},d.error=function(t,i){return d.write(t,e.extend({},{type:"error",delay:1e4},i))},d.warning=function(t,i){return d.write(t,e.extend({},{type:"warning",delay:1e4},i))},d.success=function(t,i){return d.write(t,e.extend({},{type:"success",delay:6e3},i))},d.alert=function(e){alertify.reset().dialogContainerClass("fm-popup").alert(e)},d.confirm=function(e){alertify.reset().dialogWidth(e.width).dialogPersistent(e.persistent).dialogContainerClass("fm-popup").confirm(e.message,e.okBtn,e.cancelBtn)},d.prompt=function(e){alertify.reset().dialogWidth(e.width).dialogPersistent(e.persistent).dialogContainerClass("fm-popup").theme(e.template).prompt(e.message,e.value||"",e.okBtn,e.cancelBtn)},d.dialog=function(e){alertify.reset().dialogWidth(e.width).dialogPersistent(e.persistent).dialogContainerClass("fm-popup").dialog(e.message,e.buttons)},d.setDimensions=function(){var t=u.outerHeight(!0)-u.height(),i=e(window).height()-p.height()-m.height()-t,r=h.width()-h.children(".splitter-bar-vertical").outerWidth()-b.outerWidth();h.height(i),v.width(r)},d.console=function(){k.options.logger&&arguments&&([].unshift.call(arguments,(new Date).getTime()),console.log.apply(this,arguments))};var P=function(){return e.when(K("default"),K("user")).done(function(t,i){var r=t[0],n=i[0];if(void 0!==n&&null!==n&&delete n.version,(k=e.extend({},r,n)).api.connectorUrl)x=k.api.connectorUrl;else{var o=location.origin+location.pathname,s="connectors/"+k.api.lang+"/filemanager."+k.api.lang;ae(o).length>0&&(o=o.substring(0,o.lastIndexOf("/")+1)),x=o+s}})},F=function(){return ke("GET",{mode:"initiate"}).done(function(t){if(t.data){var i=t.data.attributes.config;e.each(i,function(t,i){e.each(i,function(e,i){if(null===i)return!0;void 0===k[t]&&(k[t]=[]),k[t][e]=i})}),k.security.readOnly&&(k.options.browseOnly=!0)}}).fail(function(){d.error("Unable to perform initial request to server.")}).then(function(t){if(t.errors)return e.Deferred().reject()})},D=function(){return E=new B,e.ajax().then(function(){var e=N.param("langCode");if(e)return G(E.buildLangFileUrl(e)).done(function(){E.setLang(e)}).fail(function(){setTimeout(function(){d.error("Given language file ("+E.buildLangFileUrl(e)+") does not exist!")},500)});E.setLang(k.language.default)}).then(function(){return e.ajax({type:"GET",url:E.buildLangFileUrl(E.getLang()),dataType:"json"}).done(function(e){E.setTranslations(e)})})},z=function(){return e.when($("upload-container"),$("upload-item")).done(function(e,t){var i=e[0],r=t[0];u.append(i).append(r)})},A=function(e){var t=[],i=[];if(t.push("/themes/"+k.options.theme+"/styles/theme.css"),k.viewer.image.lazyLoad&&t.push("/scripts/lazyload/dist/lazyload.min.js"),k.customScrollbar.enabled&&(t.push("/scripts/custom-scrollbar-plugin/jquery.mCustomScrollbar.min.css"),t.push("/scripts/custom-scrollbar-plugin/jquery.mCustomScrollbar.concat.min.js")),t.push(e),V(t),k.editor.enabled){var r=k.editor.theme;r&&"default"!==r&&i.push("/scripts/CodeMirror/theme/"+r+".css"),i.push("/scripts/CodeMirror/lib/codemirror.css"),i.push("/scripts/CodeMirror/lib/codemirror.js"),i.push("/scripts/CodeMirror/addon/selection/active-line.js"),i.push("/scripts/CodeMirror/addon/display/fullscreen.css"),i.push("/scripts/CodeMirror/addon/display/fullscreen.js")}k.viewer.markdownRenderer.enabled&&(i.push("/styles/fm-markdown.css"),i.push("/scripts/markdown-it/markdown-it.min.js"),i.push("/scripts/markdown-it/default.min.css"),i.push("/scripts/markdown-it/highlight.min.js"),i.push("/scripts/markdown-it/markdown-it-footnote.min.js"),i.push("/scripts/markdown-it/markdown-it-replace-link.min.js")),k.options.browseOnly||(i.push("/scripts/jQuery-File-Upload/js/vendor/jquery.ui.widget.js"),i.push("/scripts/jQuery-File-Upload/js/canvas-to-blob.min.js"),i.push("/scripts/jQuery-File-Upload/js/load-image.all.min.js"),i.push("/scripts/jQuery-File-Upload/js/jquery.iframe-transport.js"),i.push("/scripts/jQuery-File-Upload/js/jquery.fileupload.js"),i.push("/scripts/jQuery-File-Upload/js/jquery.fileupload-process.js"),i.push("/scripts/jQuery-File-Upload/js/jquery.fileupload-image.js"),i.push("/scripts/jQuery-File-Upload/js/jquery.fileupload-validate.js"),k.upload.multiple&&i.push("/scripts/jQuery-File-Upload/css/dropzone.css")),i.length&&V(i)},U=function(){O=new R,S=k.options.capabilities||["upload","select","download","rename","copy","move","delete","extract"];var t=[];k.options.fileSorting&&(t=k.options.fileSorting.toLowerCase().split("_")),j=t[0]||"name",L=t[1]||"asc";var i=N.param("exclusiveFolder");i&&(C=se(C="/"+i+"/"));var r=N.param("expandedFolder");if(r&&(I=se(I=C+r+"/")),_=new H,ko.applyBindings(_),_.itemsModel.initiateLazyLoad(),_.filterModel.setName(N.param("filter")),ko.bindingHandlers.toggleNodeVisibility={init:function(t,i){var r=i();e(t).toggle(r.isExpanded())},update:function(t,i){var r=i();if(!1===r.isSliding())return!1;!1===r.isExpanded()&&e(t).slideDown(k.filetree.expandSpeed,function(){r.isSliding(!1),r.isExpanded(!0)}),!0===r.isExpanded()&&e(t).slideUp(k.filetree.expandSpeed,function(){r.isSliding(!1),r.isExpanded(!1)})}},ko.bindingHandlers.draggableView={init:function(e,t,i){_.ddModel.makeDraggable(t(),e)}},ko.bindingHandlers.droppableView={init:function(e,t,i){_.ddModel.makeDroppable(t(),e)}},ko.bindingHandlers.draggableTree={init:function(e,t,i){_.ddModel.makeDraggable(t(),e)}},ko.bindingHandlers.droppableTree={init:function(e,t,i){_.ddModel.makeDroppable(t(),e)}},u.mousewheel(function(t){if(!_.ddModel.dragHelper)return!0;var i=null;if((k.customScrollbar.enabled?e([g[0],b[0]]):h.children(".splitter-pane")).each(function(r){var n=e(this),o=n.offset().top,s=n.offset().left;if(t.offsetY>=o&&t.offsetY<=o+n.height()&&t.offsetX>=s&&t.offsetX<=s+n.width())return i=n,!1}),null===i)return!1;if(k.customScrollbar.enabled){var r=i.find(".mCSB_scrollTools_vertical"),n=1===t.deltaY?"+":"-";r.is(":visible")&&i.mCustomScrollbar("scrollTo",[n+"=250",0],{scrollInertia:500,scrollEasing:"easeOut",callbacks:!0})}else if(i[0].scrollHeight>i[0].clientHeight){var o=i.scrollTop()-200*t.deltaY;_.ddModel.isScrolling=!0,o=o<0?0:o,i.stop().animate({scrollTop:o},100,"linear",function(){_.ddModel.isScrolling=!1,_.ddModel.isScrolled=!0})}}),y.selectable({filter:"li:not(.directory-parent), tbody > tr:not(.directory-parent)",cancel:".directory-parent, thead",disabled:!k.manager.selection.enabled,appendTo:y,start:function(e,t){Ee(),_.itemsModel.isSelecting(!0)},stop:function(e,t){_.itemsModel.isSelecting(!1)},selected:function(e,t){ko.dataFor(t.selected).selected(!0)},unselected:function(e,t){ko.dataFor(t.unselected).selected(!1)}}),v.contextMenu({selector:".view-items",zIndex:10,build:function(e,t){var i={createFolder:{name:W("create_folder"),className:"create-folder"},paste:{name:W("clipboard_paste"),className:"paste",disabled:function(e,t){return _.clipboardModel.isEmpty()}}};return _.clipboardModel.enabled()&&!0!==k.options.browseOnly||delete i.paste,{appendTo:".fm-container",items:i,reposition:!1,callback:function(e,t){switch(e){case"createFolder":_.headerModel.createFolder();break;case"paste":_.clipboardModel.paste()}}}}}),k.extras.extra_js)for(var o=0;o<k.extras.extra_js.length;o++)e.ajax({type:"GET",url:k.extras.extra_js[o],dataType:"script",async:k.extras.extra_js_async});if(N.param("CKEditorCleanUpFuncNum")&&(_.headerModel.closeButton(!0),_.headerModel.closeButtonOnClick=function(){parent.CKEDITOR.tools.callFunction(N.param("CKEditorCleanUpFuncNum"))}),n(),Ve(),_.treeModel.loadDataNode(null,!0),k.customScrollbar.enabled&&(b.mCustomScrollbar({theme:k.customScrollbar.theme,scrollButtons:{enable:k.customScrollbar.button},advanced:{autoExpandHorizontalScroll:!0,updateOnContentResize:!0},callbacks:{onScrollStart:function(){_.ddModel.isScrolling=!0},onScroll:function(){_.ddModel.isScrolling=!1}},axis:"yx"}),w.mCustomScrollbar({theme:k.customScrollbar.theme,scrollButtons:{enable:k.customScrollbar.button},advanced:{autoExpandHorizontalScroll:!0,updateOnContentResize:!0,updateOnSelectorChange:".fm-preview-viewer"}}),g.mCustomScrollbar({theme:k.customScrollbar.theme,scrollButtons:{enable:k.customScrollbar.button},advanced:{autoExpandHorizontalScroll:!0,updateOnContentResize:!0,updateOnSelectorChange:".grid, .list"},callbacks:{onScrollStart:function(){_.itemsModel.continiousSelection()||(this.yStartPosition=this.mcs.top,this.yStartTime=(new Date).getTime()),_.ddModel.isScrolling=!0},onScroll:function(){_.ddModel.isScrolling=!1,_.ddModel.isScrolled=!0},whileScrolling:function(){if(k.manager.selection.enabled){var e=(new Date).getTime()-this.yStartTime;!_.itemsModel.continiousSelection()&&e>400&&(this.yStartPosition=this.mcs.top),_.itemsModel.isSelecting()&&_.itemsModel.continiousSelection(!0);var t=Math.abs(this.mcs.top)-Math.abs(this.yStartPosition);y.selectable("repositionCssHelper",t,0)}_.itemsModel.lazyLoad&&_.itemsModel.lazyLoad.handleScroll()}},axis:"y",alwaysShowScrollbar:0})),document.documentElement.setAttribute("data-useragent",navigator.userAgent),k.options.logger){var s=(new Date).getTime()-T;console.log("Total execution time : "+s+" ms")}c.find(".fm-loading-wrap").fadeOut(800,function(){d.setDimensions()}),d.setDimensions()},B=function(){var e=null,t={},i=d.settings.baseUrl+"/languages/";this.buildLangFileUrl=function(e){return i+e+".json"},this.setLang=function(t){e=t},this.getLang=function(){return e},this.setTranslations=function(e){t=e},this.getTranslations=function(){return t},this.translate=function(e){return t[e]}},R=function(){var e={},t=this;this.push=function(i,r,n){t.removeTimer(i),e[i]=setTimeout(r,n)},this.getTimer=function(t){return e[t]},this.removeTimer=function(t){e[t]&&(clearTimeout(e[t]),delete e[t])}},H=function(){function t(e){return(!k.manager.selection.enabled||!k.manager.selection.useCtrlKey||!0!==e.ctrlKey)&&(!k.manager.dblClickOpen||"click"!==e.type)}var i=this;this.config=ko.observable(k),this.loadingView=ko.observable(!0),this.previewFile=ko.observable(!1),this.viewMode=ko.observable(k.manager.defaultViewMode),this.currentPath=ko.observable(C),this.browseOnly=ko.observable(k.options.browseOnly),this.previewModel=ko.observable(null),this.currentLang=E.getLang(),this.lg=E.getTranslations(),this.previewFile.subscribe(function(e){e||(i.previewModel.closeEditor(),i.itemsModel.descriptivePanel.rdo().id===i.previewModel.rdo().id&&i.itemsModel.descriptivePanel.render(i.previewModel.viewer.content()))}),this.addElements=function(e,t,r){i.treeModel.addNodes(e,t,r),i.currentPath()===t&&i.itemsModel.addItems(e,t,r)},this.removeElement=function(e){var t=i.treeModel.findByParam("id",e.id);t&&t.remove();var r=i.itemsModel.findByParam("id",e.id);r&&r.remove()},this.fetchSelectedItems=function(e){var t,r;if(e===p.name)return i.itemsModel.getSelected();if(e===l.name)return i.treeModel.getSelected();if(!e)return t=i.treeModel.getSelected(),(r=i.itemsModel.getSelected()).length>0?r:t;throw new Error("Unknown item type.")},this.fetchSelectedObjects=function(t){var r=[];return e.each(i.fetchSelectedItems(t.constructor.name),function(e,t){r.push(t.rdo)}),r};var n=function(){this.beforeLoad=function(e){},this.afterLoad=function(e,t){}},l=function(t){var r=this;this.id=t.id,this.rdo=t,this.cdo={isFolder:"folder"===t.type,extension:"file"===t.type?ae(t.id):null,dimensions:t.attributes.width?t.attributes.width+"x"+t.attributes.height:null,cssItemClass:"folder"===t.type?"directory":"file",hiddenByType:!1,hiddenBySearch:!1},this.visible=ko.observable(!0),this.nodeTitle=ko.observable(t.attributes.name),this.children=ko.observableArray([]),this.parentNode=ko.observable(null),this.isSliding=ko.observable(!1),this.isLoading=ko.observable(!1),this.isLoaded=ko.observable(!1),this.isExpanded=ko.observable(!1),this.selected=ko.observable(!1),this.dragHovered=ko.observable(!1),this.level=ko.observable(0),this.isFirstNode=ko.observable(!1),this.isLastNode=ko.observable(!1),this.nodeTitle.subscribe(function(e){r.rdo.attributes.name=e}),this.children.subscribe(function(e){i.treeModel.arrangeNode(r)}),this.isLoaded.subscribe(function(e){r.isLoading(!e)}),this.selected.subscribe(function(e){e?(null!==i.treeModel.selectedNode()&&i.treeModel.selectedNode().selected(!1),i.treeModel.selectedNode(r),i.itemsModel.unselectItems()):i.treeModel.selectedNode(null)}),this.switchNode=function(e){return!!e.cdo.isFolder&&(e.rdo.attributes.readable?void(e.isLoaded()?i.treeModel.toggleNode(e):r.openNode(e)):(d.error(W("NOT_ALLOWED_SYSTEM")),!1))},this.mouseDown=function(e,t){e.selected(!0)},this.nodeClick=function(e,t){k.manager.dblClickOpen||r.openNode(e)},this.nodeDblClick=function(e,t){k.manager.dblClickOpen&&r.openNode(e)},this.openNode=function(t,r){if("file"===t.rdo.type&&s(t.rdo),"folder"===t.rdo.type)if(!t.isLoaded()||t.isExpanded()&&k.filetree.reloadOnClick)i.treeModel.loadDataNode(t,!0);else{i.treeModel.toggleNode(t);var n=[];e.each(t.children(),function(e,t){n.push(t.rdo)}),i.itemsModel.addItems(n,t.id,!0)}},this.remove=function(){r.parentNode().children.remove(r)},this.isRoot=function(){return r.level()===i.treeModel.treeData.id},this.title=ko.pureComputed(function(){return k.options.showTitleAttr?this.rdo.id:null},this),this.itemClass=ko.pureComputed(function(){var e=[];return this.selected()&&k.manager.selection.enabled&&e.push("ui-selected"),this.dragHovered()&&e.push(i.ddModel.hoveredCssClass),e.join(" ")},this),this.iconClass=ko.pureComputed(function(){var e,t=["ico"];return!0===this.cdo.isFolder?(e="ico_folder",!0===this.isLoading()?t.push("loading"):(t.push("folder"),this.rdo.attributes.readable?(this.isExpanded()||!this.isExpanded()&&this.isSliding())&&t.push("open"):t.push("lock"))):(e="ico_file",this.rdo.attributes.readable?t.push("ext",this.cdo.extension):t.push("file","lock")),e+" "+t.join("_")},this),this.switcherClass=ko.pureComputed(function(){var e=[];if(k.filetree.showLine?0===this.level()&&this.isFirstNode()&&this.isLastNode()?e.push("root"):0===this.level()&&this.isFirstNode()?e.push("roots"):this.isLastNode()?e.push("bottom"):e.push("center"):e.push("noline"),this.cdo.isFolder){var t=this.isExpanded()||!this.isExpanded()&&this.isSliding();e.push(t?"open":"close")}else e.push("docu");return e.join("_")},this),this.clusterClass=ko.pureComputed(function(){return k.filetree.showLine&&!this.isLastNode()?"line":""},this)},p=function(e){var n=k.viewer.image.thumbMaxWidth;e.attributes.width&&e.attributes.width<n&&(n=e.attributes.width),this.id=e.id,this.rdo=e,this.cdo={isFolder:"folder"===e.type,sizeFormatted:Q(e.attributes.size),extension:"file"===e.type?ae(e.id):null,dimensions:e.attributes.width?e.attributes.width+"x"+e.attributes.height:null,cssItemClass:"folder"===e.type?"directory":"file",imageUrl:Se(e,!0,!0),previewWidth:n,hiddenByType:!1,hiddenBySearch:!1},this.visible=ko.observable(!0),this.selected=ko.observable(!1),this.dragHovered=ko.observable(!1),this.lazyPreview=k.viewer.image.lazyLoad&&this.cdo.imageUrl,this.selected.subscribe(function(e){e&&null!==i.treeModel.selectedNode()&&i.treeModel.selectedNode().selected(!1)}),this.title=ko.pureComputed(function(){return k.options.showTitleAttr?this.rdo.id:null},this),this.itemClass=ko.pureComputed(function(){var e=[];return this.selected()&&k.manager.selection.enabled&&e.push("ui-selected"),this.dragHovered()&&e.push(i.ddModel.hoveredCssClass),this.cdo.cssItemClass+" "+e.join(" ")},this),this.listIconClass=ko.pureComputed(function(){var e,t=["ico"];return!0===this.cdo.isFolder?(e="ico_folder",t.push("folder"),this.rdo.attributes.readable||t.push("lock")):(e="ico_file",this.rdo.attributes.readable?t.push("ext",this.cdo.extension):t.push("file","lock")),e+" "+t.join("_")},this),this.gridIconClass=ko.pureComputed(function(){var e=[],t=["ico"];return this.cdo.imageUrl||(e.push("grid-icon"),!0===this.cdo.isFolder?(e.push("ico_folder"),t.push("folder"),this.rdo.attributes.readable||t.push("lock")):(e.push("ico_file"),this.rdo.attributes.readable?t.push("ext",this.cdo.extension):t.push("file","lock")),e.push(t.join("_"))),e.join(" ")},this),this.mouseDown=function(e,t){e.selected()||i.itemsModel.unselectItems(t.ctrlKey),i.selectionModel.unselect=e.selected(),e.selected(!0)},this.open=function(e,n){i.selectionModel.unselect&&(n.ctrlKey&&e.selected(!1),!n.ctrlKey&&k.manager.dblClickOpen&&(i.itemsModel.unselectItems(n.ctrlKey),e.selected(!0))),t(n)&&(k.options.quickSelect&&"file"===e.rdo.type&&r(e.rdo,"select")?Oe(e.rdo):s(e.rdo))},this.remove=function(){i.itemsModel.objects.remove(this)}},f=function(t){var i=this,r=null,n=[];this.setPreloader=function(e){return n.push(e),i},this.setDataHandler=function(e){return r=e,i},this.load=function(i){n.forEach(function(e,i,r){e.beforeLoad(t)}),i().then(function(i){i.data&&(r(i.data,t),e.each(n,function(e,r){r.afterLoad(t,i)}))})}},h=function(){function t(e){return ye(e)?new o:we(e)?new n:void 0}var i,r=this;this.rdo=ko.observable({}),this.content=ko.observable(null),this.renderer=ko.observable(null),this.render=function(e){r.renderer()&&r.renderer().processContent(e)},this.setRenderer=function(e){r.rdo(e),r.renderer(t(e.attributes.name))},this.setContainer=function(t){e.each(t,function(){if(e(this).hasClass("fm-renderer-container"))return i=e(this),!1}),r.renderer().processDomElements(i)};var n=function(){this.name="codeMirror",this.interactive=!1;var e=new m;this.processContent=function(t){e.render(t),r.content(t)},this.processDomElements=function(t){if(!e.instance){var i=t.find(".fm-cm-renderer-content")[0],n=ae(r.rdo().id);e.createInstance(n,i,{readOnly:"nocursor",styleActiveLine:!1,lineNumbers:!1})}}},o=function(){function t(){i.find("a").each(function(){var t=e(this).attr("href"),i=_.previewModel.editor;if(i.enabled()&&i.isInteractive())e(this).off("click"),e(this).on("click",function(){return!1});else{if(-1!=t.search("://")||ne(t,"mailto:"))return;ye(t)&&e(this).on("click",function(e){return He(t).then(function(e){e.data&&s(e.data)}),!1})}})}this.name="markdown",this.interactive=!0;var n=window.markdownit({html:!0,linkify:!0,typographer:!0,highlight:function(e,t){if(t&&hljs.getLanguage(t))try{return'<pre class="highlight"><code>'+hljs.highlight(t,e,!0).value+"</code></pre>"}catch(e){}return'<pre class="highlight"><code>'+n.utils.escapeHtml(e)+"</code></pre>"},replaceLink:function(e,t){if(-1!=e.search("://")||ne(e,"mailto:"))return e;var i=(ne(e,"/")?C:de(r.rdo().id))+ie(e,"/");if(ye(i))return i;var n=Me("GET",{mode:"readfile",path:i});return Ce(n)}}).use(window.markdownitReplaceLink);this.processContent=function(e){var i=n.render(e);r.content(i),t()},this.processDomElements=function(e){}}},m=function(){function t(e){r.enabled(!0),r.instance.setValue(e),setTimeout(function(){r.instance.refresh()},0)}function i(e){var t=[],i="default";k.editor.codeHighlight&&("js"===e&&(t.push("/scripts/CodeMirror/mode/javascript/javascript.js"),i="javascript"),"css"===e&&(t.push("/scripts/CodeMirror/mode/css/css.js"),i="css"),"html"===e&&(t.push("/scripts/CodeMirror/mode/xml/xml.js"),i="text/html"),"xml"===e&&(t.push("/scripts/CodeMirror/mode/xml/xml.js"),i="application/xml"),"php"===e&&(t.push("/scripts/CodeMirror/mode/htmlmixed/htmlmixed.js"),t.push("/scripts/CodeMirror/mode/xml/xml.js"),t.push("/scripts/CodeMirror/mode/javascript/javascript.js"),t.push("/scripts/CodeMirror/mode/css/css.js"),t.push("/scripts/CodeMirror/mode/clike/clike.js"),t.push("/scripts/CodeMirror/mode/php/php.js"),i="application/x-httpd-php"),"java"===e&&(t.push("/scripts/CodeMirror/mode/clike/clike.js"),i="text/x-java"),"sql"===e&&(t.push("/scripts/CodeMirror/mode/sql/sql.js"),i="text/x-mysql"),"md"===e&&(t.push("/scripts/CodeMirror/addon/mode/overlay.js"),t.push("/scripts/CodeMirror/mode/xml/xml.js"),t.push("/scripts/CodeMirror/mode/markdown/markdown.js"),t.push("/scripts/CodeMirror/mode/gfm/gfm.js"),t.push("/scripts/CodeMirror/mode/javascript/javascript.js"),t.push("/scripts/CodeMirror/mode/css/css.js"),t.push("/scripts/CodeMirror/mode/htmlmixed/htmlmixed.js"),t.push("/scripts/CodeMirror/mode/clike/clike.js"),t.push("/scripts/CodeMirror/mode/shell/shell.js"),t.push("/scripts/CodeMirror/mode/meta.js"),i="gfm"),"sh"===e&&(t.push("/scripts/CodeMirror/addon/mode/overlay.js"),t.push("/scripts/CodeMirror/mode/markdown/markdown.js"),t.push("/scripts/CodeMirror/mode/gfm/gfm.js"),t.push("/scripts/CodeMirror/mode/javascript/javascript.js"),t.push("/scripts/CodeMirror/mode/css/css.js"),t.push("/scripts/CodeMirror/mode/htmlmixed/htmlmixed.js"),t.push("/scripts/CodeMirror/mode/clike/clike.js"),t.push("/scripts/CodeMirror/mode/meta.js"),t.push("/scripts/CodeMirror/mode/shell/shell.js"),i="shell")),t.length?(t.push(function(){r.mode(i)}),V(t)):r.mode(i)}var r=this,n=null;this.instance=null,this.enabled=ko.observable(!1),this.content=ko.observable(null),this.mode=ko.observable(null),this.isInteractive=ko.observable(!1),this.mode.subscribe(function(e){e&&(r.instance.setOption("mode",e),n&&(t(n),n=null))}),this.render=function(e){r.mode()?t(e):n=e},this.createInstance=function(t,n,o){var s,a={readOnly:"nocursor",styleActiveLine:!1,viewportMargin:1/0,lineNumbers:k.editor.lineNumbers,lineWrapping:k.editor.lineWrapping,theme:k.editor.theme,matchBrackets:k.editor.matchBrackets,extraKeys:{F11:function(e){e.setOption("fullScreen",!e.getOption("fullScreen"))},Esc:function(e){e.getOption("fullScreen")&&e.setOption("fullScreen",!1)}}};(s=CodeMirror.fromTextArea(n,e.extend({},a,o))).on("changes",function(e,t){r.content(e.getValue())}),r.instance=s,i(t)}};this.treeModel=new function(){var t=this;this.selectedNode=ko.observable(null),this.treeData={id:C,level:ko.observable(-1),children:ko.observableArray([])},this.treeData.children.subscribe(function(e){t.arrangeNode(t.treeData)});var r=function(e){if(null!==I){e||(e=t.treeData);var i=t.findByFilter(function(e){return 0===I.indexOf(e.id)},e);i?(k.filetree.expandSpeed=10,t.loadDataNode(i,!0)):(I=null,k.filetree.expandSpeed=200)}};this.mapNodes=function(e,i){i||(i=t.treeData),i.id!==t.treeData.id&&e.call(this,i);var r=i.children();if(!r||0===r.length)return null;for(var n=0,o=r.length;n<o;n++)e.call(this,r[n]),t.findByFilter(e,r[n])},this.findByParam=function(e,i,r){if(!r&&(r=t.treeData)[e]===i)return r;var n=r.children();if(!n||0===n.length)return null;for(var o=0,s=n.length;o<s;o++){if(n[o][e]===i)return n[o];var a=t.findByParam(e,i,n[o]);if(a)return a}return null},this.findByFilter=function(e,i){if(!i&&(i=t.treeData,e(i)))return i;var r=i.children();if(!r||0===r.length)return null;for(var n=0,o=r.length;n<o;n++){if(e(r[n]))return r[n];var s=t.findByFilter(e,r[n]);if(s)return s}return null},this.getSelected=function(){var e=[];return t.selectedNode()&&e.push(t.selectedNode()),e},this.loadDataNode=function(e,r){var n=e?e.id:t.treeData.id;new f(n).setPreloader(i.itemsModel.getPreloader()).setPreloader(t.getPreloader(e)).setDataHandler(function(e,n){t.addNodes(e,n,r),i.itemsModel.addItems(e,n,r),i.searchModel.clearInput()}).load(function(){return Be(n)})},this.getPreloader=function(e){var i=function(){};return i.prototype=Object.create(n),i.prototype.beforeLoad=function(t){e&&e.isLoaded(!1)},i.prototype.afterLoad=function(i,n){e&&(e.isLoaded(!0),t.expandNode(e)),r(e)},new i},this.createNode=function(e){var t=new l(e);return _.filterModel.filterItem(t),t},this.createNodes=function(i){var r=[];return e.each(i,function(e,i){r.push(t.createNode(i))}),r},this.appendNodes=function(i,r){e.isArray(r)||(r=[r]),i||(i=t.treeData),k.filetree.foldersOnly&&(r=e.grep(r,function(e){return e.cdo.isFolder})),e.each(r,function(e,t){t.parentNode(i)});var n=i.children().concat(r);i.children(q(n))},this.addNodes=function(i,r,n){e.isArray(i)||(i=[i]);var o=t.findByParam("id",r);if(o){var s=t.createNodes(i);n&&o.children([]),t.appendNodes(o,s)}},this.expandNode=function(e){return!1===e.isExpanded()&&!0===e.isLoaded()&&(e.isSliding(!0),!0)},this.collapseNode=function(e){return!0===e.isExpanded()&&(e.isSliding(!0),!0)},this.toggleNode=function(e){t.collapseNode(e)||t.expandNode(e)},this.arrangeNode=function(t){var i=t.children().length;e.each(t.children(),function(e,r){r.level(t.level()+1),r.isFirstNode(0===e),r.isLastNode(e===i-1)})},this.nodeRendered=function(t,r){e(t[1]).contextMenu({selector:".file, .directory",zIndex:100,build:function(e,t){return r.selected(!0),{appendTo:".fm-container",items:a(r.rdo),callback:function(e,t){Ke(e,t,r.rdo,i.fetchSelectedObjects(r))}}}})},this.actualizeNodeObject=function(i,r,n){var o=new RegExp("^"+r),s=i.rdo.id,a=s.replace(o,n);i.id=a,i.rdo.id=a,i.rdo.attributes.path=i.rdo.attributes.path.replace(new RegExp(s+"$"),a),i.children().length&&e.each(i.children(),function(e,i){t.actualizeNodeObject(i,r,n)})}},this.itemsModel=new function(){var r=this;this.objects=ko.observableArray([]),this.parentItem=ko.observable(null),this.objectsSize=ko.observable(0),this.objectsNumber=ko.observable(0),this.selectedNumber=ko.observable(0),this.listSortField=ko.observable(j),this.listSortOrder=ko.observable(L),this.isSelecting=ko.observable(!1),this.continiousSelection=ko.observable(!1),this.descriptivePanel=new h,this.lazyLoad=null,this.isSelecting.subscribe(function(e){e||r.continiousSelection(!1)}),this.createItem=function(e){var t=new p(e);return _.filterModel.filterItem(t),t},this.createItems=function(t){var i=[];return e.each(t,function(e,t){i.push(r.createItem(t))}),i},this.appendItems=function(t){e.isArray(t)||(t=[t]);var i=r.objects().concat(t);r.objects(q(i))},this.addItems=function(t,n,o){e.isArray(t)||(t=[t]);var s=r.createItems(t);o?(i.currentPath(n),i.breadcrumbsModel.splitCurrent(),r.setDescriptivePanel(t),r.setItemsList(s),r.addParentItem()):r.appendItems(s)},this.loadDataList=function(e){new f(e).setPreloader(r.getPreloader()).setDataHandler(function(e,t){r.addItems(e,t,!0),i.searchModel.clearInput()}).load(function(){return Be(e)})},this.setItemsList=function(e){r.parentItem(null),e=q(e),r.objects(e)},this.addParentItem=function(){if(!ee(i.currentPath())&&i.currentPath()!==C){var e=ce(i.currentPath()),n={id:e,rdo:{id:e,type:"parent",attributes:{readable:!0,writable:!0}},dragHovered:ko.observable(!1)};n.open=function(e,i){t(i)&&r.loadDataList(n.id)},n.itemClass=ko.pureComputed(function(){var e=[];return n.dragHovered()&&e.push(i.ddModel.hoveredCssClass),e.join(" ")}),r.parentItem(n)}},this.setDescriptivePanel=function(t){r.descriptivePanel.content(null),e.each(t,function(e,t){k.manager.renderer.position&&"string"==typeof k.manager.renderer.indexFile&&t.attributes.name.toLowerCase()===k.manager.renderer.indexFile.toLowerCase()&&(r.descriptivePanel.setRenderer(t),Ue(r.descriptivePanel.rdo()).then(function(e){r.descriptivePanel.render(e)}))})},this.findByParam=function(e,t){return ko.utils.arrayFirst(r.objects(),function(i){return i[e]===t})},this.findByFilter=function(e,t){var i=!t,n=[],o=r.objects();if(!o||0===o.length)return null;for(var s=0,a=o.length;s<a;s++)if(e(o[s])){if(i)return o[s];n.push(o[s])}return i?null:n},this.sortObjects=function(){var e=q(r.objects());r.objects(e)},this.getSelected=function(){var e=r.findByFilter(function(e){return e.selected()},!0);return r.selectedNumber(e.length),e},this.unselectItems=function(t){k.manager.selection.enabled&&k.manager.selection.useCtrlKey&&!0===t||e.each(r.getSelected(),function(e,t){t.selected(!1)})},this.initiateLazyLoad=function(){!0!==k.viewer.image.lazyLoad||r.lazyLoad||(r.lazyLoad=new LazyLoad({container:v[0],callback_load:function(e){d.console("LOADED",e.getAttribute("data-original"))},callback_set:function(e){d.console("SET",e.getAttribute("data-original"))},callback_processed:function(e){d.console("PROCESSED",e+" images left")}}))},this.getPreloader=function(){var e=function(){};return e.prototype=Object.create(n),e.prototype.beforeLoad=function(e){i.loadingView(!0)},e.prototype.afterLoad=function(e,t){i.loadingView(!1),r.lazyLoad&&r.lazyLoad.update()},new e},this.objects.subscribe(function(t){var n=0,o=0;e.each(t,function(e,t){n++,"file"===t.rdo.type&&(o+=Number(t.rdo.attributes.size))}),r.objectsNumber(n),r.objectsSize(Q(o)),r.lazyLoad&&setTimeout(function(){r.lazyLoad.update()},50),y.contextMenu({selector:".file, .directory",zIndex:100,build:function(e,t){var r=ko.dataFor(e[0]);return r.selected()||(i.itemsModel.unselectItems(!1),r.selected(!0)),{appendTo:".fm-container",items:a(r.rdo),callback:function(e,t){Ke(e,t,r.rdo,i.fetchSelectedObjects(r))}}}})})},this.tableViewModel=new function(){var e=function(e){var t=this;this.column=ko.observable(e),this.order=ko.observable(i.itemsModel.listSortOrder()),this.sortClass=ko.pureComputed(function(){var e;return i.itemsModel.listSortField()===t.column()&&(e="sorted sorted-"+this.order()),e},this),this.sort=function(){var e="asc"===t.order(),r=i.itemsModel.listSortField()===t.column();t.order(r?e?"desc":"asc":i.itemsModel.listSortOrder()),i.itemsModel.listSortField(t.column()),i.itemsModel.listSortOrder(t.order()),i.itemsModel.sortObjects()}};this.thName=new e("name"),this.thType=new e("type"),this.thSize=new e("size"),this.thDimensions=new e("dimensions"),this.thModified=new e("modified")},this.previewModel=new function(){var e=this,t=null;this.rdo=ko.observable({}),this.cdo=ko.observable({}),this.viewer={type:ko.observable("default"),isEditable:ko.observable(!1),url:ko.observable(null),pureUrl:ko.observable(null),options:ko.observable({}),content:ko.observable(null),codeMirror:ko.observable(null)},this.renderer=new h,this.editor=new m,this.rdo.subscribe(function(t){e.cdo({isFolder:"folder"===t.type,sizeFormatted:Q(t.attributes.size),extension:"file"===t.type?ae(t.id):null,dimensions:t.attributes.width?t.attributes.width+"x"+t.attributes.height:null})}),this.editor.content.subscribe(function(t){e.editor.isInteractive()&&e.renderer.render(t)}),this.applyObject=function(r){t&&t.destroy(),i.previewFile(!1);var n=r.attributes.name,o={interactive:!1},s={type:"default",url:null,options:{}};e.rdo(r),fe(n)&&(s.type="image",s.url=Se(r,!1,!0)),me(n)&&!0===k.viewer.audio.enabled&&(s.type="audio",s.url=xe(r,!0)),he(n)&&!0===k.viewer.video.enabled&&(s.type="video",s.url=xe(r,!0),s.options={width:k.viewer.video.playerWidth,height:k.viewer.video.playerHeight}),be(n)&&!0===k.viewer.opendoc.enabled&&(s.type="opendoc",s.url=d.settings.baseUrl+"/scripts/ViewerJS/index.html#"+xe(r,!0),s.options={width:k.viewer.opendoc.readerWidth,height:k.viewer.opendoc.readerHeight}),ge(n)&&!0===k.viewer.google.enabled&&(s.type="google",s.url="https://docs.google.com/viewer?url="+encodeURIComponent(xe(r,!1))+"&embedded=true",s.options={width:k.viewer.google.readerWidth,height:k.viewer.google.readerHeight}),ve(n)&&!0===k.viewer.iframe.enabled&&(s.type="iframe",s.url=xe(r,!0),s.options={width:k.viewer.iframe.readerWidth,height:k.viewer.iframe.readerHeight}),(we(n)&&!0===k.viewer.codeMirrorRenderer.enabled||ye(n)&&!0===k.viewer.markdownRenderer.enabled)&&(s.type="renderer",s.options={is_writable:r.attributes.writable},e.renderer.setRenderer(r),o.interactive=e.renderer.renderer().interactive),e.viewer.type(s.type),e.viewer.url(s.url),e.viewer.options(s.options),e.viewer.pureUrl(Le(r)),e.viewer.isEditable(pe(n)&&!0===k.editor.enabled),e.editor.isInteractive(o.interactive),"renderer"===s.type||e.viewer.isEditable()?Ue(r).then(function(t){e.viewer.content(t),i.previewFile(!0)}):i.previewFile(!0)},this.afterRender=function(){e.renderer.render(e.viewer.content());var i=w.find(".btn-copy-url")[0];(t=new Clipboard(i)).on("success",function(e){d.success(W("copied"))})},this.initiateEditor=function(t){var i=w.find(".fm-cm-editor-content")[0];e.editor.createInstance(e.cdo().extension,i,{readOnly:!1,styleActiveLine:!0})},this.bindToolbar=function(t){r(e.rdo(),t)&&Ke(t,{},e.rdo())},this.previewIconClass=ko.pureComputed(function(){var t=[],i=["ico"];return"default"!==e.viewer.type()&&e.viewer.url()||(t.push("grid-icon"),!0===this.cdo().isFolder?(t.push("ico_folder"),i.push("folder"),this.rdo().attributes.readable||i.push("lock")):(t.push("ico_file"),this.rdo().attributes.readable?i.push("ext",this.cdo().extension):i.push("file","lock")),t.push(i.join("_"))),t.join(" ")},this),this.editFile=function(){var t=e.viewer.content();e.renderer.render(t),e.editor.render(t)},this.saveFile=function(){Ae(e.rdo())},this.closeEditor=function(){e.editor.enabled(!1),e.renderer.render(e.viewer.content())},this.buttonVisibility=function(t){switch(t){case"select":return r(e.rdo(),t)&&o();case"move":case"rename":case"delete":case"download":return r(e.rdo(),t)}}},this.headerModel=new function(){this.closeButton=ko.observable(!1),this.langSwitcher=e.isArray(k.language.available)&&k.language.available.length>0,this.closeButtonOnClick=function(){d.console("CLOSE button is clicked")},this.navHome=function(){i.previewFile(!1),i.itemsModel.loadDataList(C)},this.navLevelUp=function(){var e=i.previewFile()?de(i.previewModel.rdo().id):ce(i.currentPath());i.previewFile()&&i.previewFile(!1),e!==i.currentPath()&&i.itemsModel.loadDataList(e)},this.navRefresh=function(){i.previewFile()?(i.previewFile(!1),i.previewFile(!0)):i.itemsModel.loadDataList(i.currentPath())},this.displayGrid=function(){i.viewMode("grid"),i.previewFile(!1),i.itemsModel.lazyLoad&&i.itemsModel.lazyLoad.update()},this.displayList=function(){i.viewMode("list"),i.previewFile(!1)},this.switchLang=function(t){var i=t.target.value,r=E.getLang();if(i&&i.toLowerCase()!==r.toLowerCase()){var n,o=window.location.toString(),s=new RegExp("(langCode=)"+r);n=s.test(o)?o.replace(s,"$1"+i):o+(e.isEmptyObject(N.param())?"?":"#")+"langCode="+i,window.location.href=n}},this.createFolder=function(){d.prompt({message:W("prompt_foldername"),value:W("default_foldername"),okBtn:{label:W("create_folder"),autoClose:!1,click:function(e,t){var i=t.getInputValue();i?ke("GET",{mode:"addfolder",path:_.currentPath(),name:i}).done(function(e){e.data&&(_.addElements(e.data,_.currentPath()),t.closeDialog(),k.options.showConfirmation&&d.success(W("successful_added_folder")))}).fail(X):d.error(W("no_foldername"))}},cancelBtn:{label:W("cancel")}})}},this.summaryModel=new function(){this.files=ko.observable(null),this.folders=ko.observable(null),this.size=ko.observable(null),this.enabled=ko.observable(!1),this.doSummarize=function(){We()}},this.filterModel=new function(){var t=this;this.name=ko.observable(null),this.setName=function(i){i&&k.filter&&e.isArray(k.filter[i])&&t.name(i)},this.getExtensions=function(){return t.name()?k.filter[t.name()]:null},this.filterItem=function(i){var r=t.getExtensions(),n=!i.cdo.hiddenBySearch;if(i.cdo.hiddenByType=!1,"file"===i.rdo.type&&e.isArray(r)){var o=ae(i.id),s=-1!==r.indexOf(o);n=n&&s,i.cdo.hiddenByType=!s}i.visible(n)},this.filter=function(r){t.setName(r),e.each(i.itemsModel.objects(),function(e,i){t.filterItem(i)}),i.treeModel.mapNodes(function(e){t.filterItem(e)}),i.itemsModel.lazyLoad&&i.itemsModel.lazyLoad.update()},this.reset=function(){t.name(null),t.filter(null)}},this.searchModel=new function(){function t(){k.search.typingDelay?O.push("search",function(){r()},k.search.typingDelay):r()}function r(){var t=o.value(),r=k.search.caseSensitive?t:t.toLowerCase();if(""!==t)if(k.search.recursive){var a=i.currentPath();new f(a).setPreloader(i.itemsModel.getPreloader()).setDataHandler(function(t,n){var o=[];k.search.caseSensitive?e.each(t,function(e,t){0===t.attributes.name.indexOf(r)&&o.push(t)}):o=t;var s=i.itemsModel.createItems(o);i.itemsModel.setItemsList(s)}).load(function(){return Re(a,t)})}else e.each(i.itemsModel.objects(),function(e,t){var i=t.rdo.attributes.name;k.search.caseSensitive||(i=i.toLowerCase());var n=0===i.indexOf(r),o=!t.cdo.hiddenByType;o=o&&n,t.cdo.hiddenBySearch=!n,t.visible(o)});else t!==s?n():d.warning(W("search_string_empty"))}function n(){o.clearInput(),k.search.recursive?i.itemsModel.loadDataList(i.currentPath()):e.each(i.itemsModel.objects(),function(e,t){t.cdo.hiddenBySearch=!1,t.visible(!t.cdo.hiddenByType)})}var o=this,s="";this.value=ko.observable(""),this.value.subscribe(function(e){s=e},null,"beforeChange"),this.inputKey=function(e,i){k.search.typingDelay&&o.value(i.target.value),(k.search.typingDelay||13===i.which||13===i.keyCode)&&t()},this.seekItems=function(e,i){t()},this.reset=function(e,t){n()},this.clearInput=function(){o.value(""),s=o.value(),O.removeTimer("search")}},this.clipboardModel=new function(){function e(){r=[],t=null,n.itemsNum(0)}var t=null,r=[],n=this,o=S.indexOf("copy")>-1||S.indexOf("move")>-1;this.itemsNum=ko.observable(0),this.enabled=ko.observable(i.config().clipboard.enabled&&o),this.copy=function(){n.hasCapability("copy")&&(t="copy",r=i.fetchSelectedItems(),n.itemsNum(r.length))},this.cut=function(){n.hasCapability("cut")&&(t="cut",r=i.fetchSelectedItems(),n.itemsNum(r.length))},this.paste=function(){var o=i.currentPath();n.hasCapability("paste")&&!n.isEmpty()&&(null!==t&&0!==r.length?_e(r,function(e,i){return"cut"===t?Pe(i,o):"copy"===t?Te(i,o):void 0},e):d.warning(W("clipboard_empty")))},this.clear=function(){n.hasCapability("clear")&&!n.isEmpty()&&(e(),d.success(W("clipboard_cleared")))},this.isEmpty=function(){return 0===r.length},this.hasCapability=function(e){if(!n.enabled)return!1;switch(e){case"copy":return S.indexOf("copy")>-1;case"cut":return S.indexOf("move")>-1;default:return!0}}},this.breadcrumbsModel=new function(){var e=this;this.items=ko.observableArray([]),this.clean=function(){e.items([]),e.add(C,"")},this.add=function(i,r){e.items.push(new t(i,r))},this.splitPath=function(t){var i=C,r=t.replace(new RegExp("^"+C),"").split("/");for(e.clean();r.length>0;){var n=r.shift();n&&(i+=n+"/",e.add(i,n))}},this.splitCurrent=function(){e.splitPath(i.currentPath())},this.getLabel=ko.pureComputed(function(){return W(i.searchModel.value()?"search_results":"current_folder")+": "},this);var t=function(e,t){var r=this;this.path=e,this.label=t,this.isRoot=e===C,this.active=e===i.currentPath(),this.itemClass=function(){var e=["nav-item"];return r.isRoot&&e.push("root"),r.active&&e.push("active"),e.join(" ")},this.goto=function(e,t){e.active||i.itemsModel.loadDataList(e.path)}}},this.ddModel=new function(){function t(t){var i=e.grep(o.items,function(e,i){if("folder"===t.rdo.type||"parent"===t.rdo.type){if(ne(t.rdo.id,e.rdo.id))return!0;if(t.rdo.id===ue(e.rdo.id))return!0}return e.id===t.id});return t.rdo.attributes.writable&&0===i.length}function r(e){null!==o.hoveredItem&&o.hoveredItem.dragHovered(!1),o.hoveredItem=e,e&&e.dragHovered(!0)}function n(e,t){t?e.addClass(s):e.removeClass(s)}var o=this,s="drop-restricted",a=e("#drag-helper-template");this.items=[],this.hoveredItem=null,this.dragHelper=null,this.isScrolling=!1,this.isScrolled=!1,this.hoveredCssClass="drop-hover",this.makeDraggable=function(t,r){"file"!==t.rdo.type&&"folder"!==t.rdo.type||e(r).draggable({distance:3,cursor:"pointer",cursorAt:{left:Math.floor(a.width()/2),bottom:15},scroll:!1,appendTo:u,containment:c,refreshPositions:!1,helper:function(){var e,r;return r=i.fetchSelectedItems(t.constructor.name).length>1?"ico_multiple":"folder"===t.rdo.type?"ico_folder":"ico_file ico_ext_"+ae(t.rdo.id),(e=a.children(".drag-helper").clone()).find(".clip").addClass(r),o.dragHelper=e,e},start:function(e,r){o.items=i.fetchSelectedItems(t.constructor.name)},drag:function(t,i){e(this).draggable("option","refreshPositions",o.isScrolling||o.isScrolled),o.isScrolled=!1},stop:function(e,t){o.items=[],o.dragHelper=null}})},this.makeDroppable=function(i,s){"folder"!==i.rdo.type&&"parent"!==i.rdo.type||e(s).droppable({tolerance:"pointer",enableExtendedEvents:i instanceof p,accept:function(e){var t=ko.dataFor(e[0]),i=t?t.rdo.type:null;return"file"===i||"folder"===i},over:function(e,o){setTimeout(function(){r(null),n(o.helper,!1),t(i)||n(o.helper,!0),r(i)},0)},out:function(e,t){r(null),n(t.helper,!1)},drop:function(e,n){if(r(null),!t(i))return!1;_e(o.items,function(e,t){return Pe(t.rdo,i.id)})}})}},this.selectionModel=new function(){this.unselect=!1}},W=function(e){return E.translate(e)},q=function(e){function t(e){var t,i=j;switch("list"===_.viewMode()&&(i=_.itemsModel.listSortField()),i){case"type":t=e.cdo.extension||"";break;case"size":t=e.rdo.attributes.size;break;case"modified":t=e.rdo.attributes.timestamp;break;case"dimensions":t=e.cdo.dimensions||"";break;default:t=e.rdo.attributes.name}return"string"==typeof t&&(n.cases||(t=t.toLowerCase()),t=t.replace(/\s+/g," ")),t}function i(e,t){for(var i=r(e.toString()),n=r(t.toString()),o=0;i[o]&&n[o];o++)if(i[o]!==n[o]){var s=Number(i[o]),a=Number(n[o]);return s==i[o]&&a==n[o]?s-a:i[o]>n[o]?1:-1}return i.length-n.length}function r(e){for(var t,i,r=[],n=0,o=-1,s=0;t=(i=e.charAt(n++)).charCodeAt(0);){var a=46==t||t>=48&&t<=57;a!==s&&(r[++o]="",s=a),r[o]+=i}return r}var n={natural:!0,order:"asc"===("list"===_.viewMode()?_.itemsModel.listSortOrder():L)?1:-1,cases:!1};e.sort(function(e,r){var o,s=t(e),a=t(r);return o=s===a?0:void 0===s||void 0===a?0:n.natural&&(isNaN(s)||isNaN(a))?i(s,a):s<a?-1:s>a?1:0,o*=n.order});for(var o=[],s=e.length;s--;)"folder"===e[s].rdo.type&&(o.push(e[s]),e.splice(s,1));"top"!==k.options.folderPosition&&o.reverse();for(var a=0,l=o.length;a<l;a++)"top"===k.options.folderPosition?e.unshift(o[a]):e.push(o[a]);return e},G=function(t){return e.ajax({type:"HEAD",url:t})},K=function(t){var i=null;return t=void 0===t?"user":t,i="user"===t?N.param("config")?d.settings.baseUrl+"/config/"+N.param("config"):d.settings.baseUrl+"/config/filemanager.config.json":d.settings.baseUrl+"/config/filemanager.config.default.json",e.ajax({type:"GET",url:i,dataType:"json",cache:!1,error:function(e){d.error("Given config file ("+i+") does not exist!")}})},V=function(e){for(var t=0,i=e.length;t<i;t++)"string"==typeof e[t]&&(e[t]=d.settings.baseUrl+e[t]);toast.apply(this,e)},$=function(t,i){return e.ajax({type:"GET",url:d.settings.baseUrl+"/scripts/templates/"+t+".html",error:X})},Q=function(e,t){if(!e)return"";t=t||!1;for(var i=parseFloat(e),r=parseFloat(t?1e3:1024),n=0,o=[W("unit_bytes"),W("unit_kb"),W("unit_mb"),W("unit_gb")];;){if(i<r)return(i=Math.round(100*i)/100)+" "+o[n];i/=r,n+=1}},Y=function(t){var i;return E.getLang()&&W(t.title)?(i=W(t.title),e.each(t.meta.arguments,function(e,t){i=i.replace("%s",t)})):i=t.title,i},J=function(t){d.console("ERROR JSON",t),e.each(t,function(e,t){d.error(Y(t)),t.meta.redirect&&(window.location.href=t.meta.redirect)})},X=function(t){var i;if(e.isPlainObject(t)&&t.responseText){var r="application/json"===t.getResponseHeader("content-type");!t.responseJSON&&r&&(t.responseJSON=e.parseJSON(t.responseText)),e.isPlainObject(t.responseJSON)&&t.responseJSON.errors?J(t.responseJSON.errors):i=W("ERROR_SERVER")+" "+t.responseText}else i=t;i&&(d.console("ERROR TEXT",i),d.error(i))};!function(e){e.extend({inArrayInsensitive:function(t,i,r){if("string"!=typeof t)return e.inArray.apply(this,arguments);if(i){var n=i.length;for(r=r?r<0?Math.max(0,n+r):r:0,t=t.toLowerCase();r<n;r++)if(r in i&&i[r].toLowerCase()==t)return r}return-1}})}(jQuery);var Z=function(t){var i=ae(t);if(k.security.extensions.ignoreCase){if("ALLOW_LIST"==k.security.extensions.policy&&-1!==e.inArrayInsensitive(i,k.security.extensions.restrictions))return!0;if("DISALLOW_LIST"==k.security.extensions.policy&&-1===e.inArrayInsensitive(i,k.security.extensions.restrictions))return!0}else{if("ALLOW_LIST"==k.security.extensions.policy&&-1!==e.inArray(i,k.security.extensions.restrictions))return!0;if("DISALLOW_LIST"==k.security.extensions.policy&&-1===e.inArray(i,k.security.extensions.restrictions))return!0}return!1},ee=function(e){return"/"!==e.charAt(e.length-1)},te=function(e,t){var i=new RegExp("^"+t+"+|"+t+"+$","g");return e.replace(i,"")},ie=function(e,t){var i=new RegExp("^"+t+"+","g");return e.replace(i,"")},re=function(e,t){var i=new RegExp(t+"+$","g");return e.replace(i,"")},ne=function(e,t,i){return i=i||0,e.substr(i,t.length)===t},oe=function(t){var i=[];return e.each(t.split("/"),function(e,t){i.push(encodeURIComponent(t))}),i.join("/")},se=function(e){return e.replace(/\\/g,"/").replace(/\/+/g,"/")},ae=function(e){return 1===e.split(".").length?"":e.split(".").pop().toLowerCase()},le=function(e){return-1!==e.lastIndexOf(".")?e.substring(0,e.lastIndexOf(".")):e},de=function(e){return e.lastIndexOf("/")!==e.length-1?e.substr(0,e.lastIndexOf("/")+1):e},ce=function(e){return e.split("/").reverse().slice(2).reverse().join("/")+"/"},ue=function(e){return e.substring(0,e.slice(0,-1).lastIndexOf("/"))+"/"},pe=function(t){return-1!==e.inArray(ae(t),k.editor.extensions)},fe=function(t){return-1!==e.inArray(ae(t),k.viewer.image.extensions)},he=function(t){return-1!==e.inArray(ae(t),k.viewer.video.extensions)},me=function(t){return-1!==e.inArray(ae(t),k.viewer.audio.extensions)},ve=function(t){return-1!==e.inArray(ae(t),k.viewer.iframe.extensions)},be=function(t){return-1!==e.inArray(ae(t),k.viewer.opendoc.extensions)},ge=function(t){return-1!==e.inArray(ae(t),k.viewer.google.extensions)},we=function(t){return-1!==e.inArray(ae(t),k.viewer.codeMirrorRenderer.extensions)},ye=function(t){return-1!==e.inArray(ae(t),k.viewer.markdownRenderer.extensions)},Me=function(t,i){var r,n=k.api.requestParams;if(t=t.toUpperCase(),e.isPlainObject(n)&&(r=n[t],e.isPlainObject(r)&&!e.isEmptyObject(r))){var o=e.extend({},n.MIXED||{},r);"POST"===t&&e.isArray(i)?e.each(o,function(e,t){i.push({name:e,value:t})}):i=e.extend({},i,o)}return i=d.settings.callbacks.beforeSetRequestParams(t,i)},ke=function(t,i,r){return r=void 0===r?"json":r,!1===d.settings.callbacks.beforeSendRequest(t,i)?e.Deferred().reject(W("NOT_ALLOWED")):e.ajax({type:t,cache:!1,url:Ce(),dataType:r,data:Me(t,i)})},Ce=function(t){var i={time:(new Date).getTime()},r=e.extend({},t||{},i);return x+"?"+e.param(r)},xe=function(e,t){var i,r=e.attributes.path;if(k.viewer.absolutePath&&r)t&&(r=oe(r)),i=je(r,!1);else{var n=Me("GET",{mode:"readfile",path:e.id});i=Ce(n)}return i=d.settings.callbacks.beforeCreatePreviewUrl(e,i)},Se=function(e,t,i){var r;if(fe(e.id)&&e.attributes.readable&&(t&&k.viewer.image.showThumbs||!t&&!0===k.viewer.image.enabled)){if(k.viewer.absolutePath&&!t&&e.attributes.path)r=je(oe(e.attributes.path),i);else{var n={path:e.id};"svg"===ae(e.id)?n.mode="readfile":(n.mode="getimage",t&&(n.thumbnail="true")),n=Me("GET",n),r=Ce(n)}r=d.settings.callbacks.beforeCreateImageUrl(e,r)}return r},je=function(e,t){var i="string"==typeof k.viewer.previewUrl?k.viewer.previewUrl:location.origin;return i=te(i,"/")+e,t&&(i+="?time="+(new Date).getTime()),i},Le=function(e){function t(e){return k.clipboard.encodeCopyUrl?oe(e):e}if(k.viewer.absolutePath&&e.attributes.path){i=t(e.attributes.path);return je(i,!1)}var i=t(e.id),r="folder"===e.type?"readfolder":"readfile";return x+"?path="+i+"&mode="+r},_e=function(t,i,r){var n,o=new function(){this.total=0,this.succeed=0,this.failure=0,this.processed=0,this.getProgress=function(){return Math.round(this.processed/this.total*100)},this.getProgressSucceed=function(){return Math.round(this.succeed/this.total*100)},this.getProgressFailure=function(){return Math.round(this.failure/this.total*100)},this.getMessage=function(){return W("successful_processed").replace("%s",this.succeed).replace("%s",this.total)},this.succeeded=function(){this.succeed++,this.processed++},this.failed=function(){this.failure++,this.processed++},this.isProcessed=function(){return this.processed===this.total}},s=e.Deferred().resolve();o.total=t.length,o.total>1&&(n=d.write(o.getMessage(),{delay:0,logMessageTemplate:function(e){o.getProgress();var t=o.isProcessed()?"striped":"striped animated";return"<div>"+e+'</div><div class="progress"><div class="progress-counter">'+o.getProgress()+'%</div><div class="progress-bar '+t+'"><div class="progress-segment progress-succeed" style="width: '+o.getProgressSucceed()+'%"></div><div class="progress-segment progress-failure" style="width: '+o.getProgressFailure()+'%"></div></div></div>'}})).stick(!0),e.each(t,function(e,t){s=s.then(function(){return i(e,t)}).then(function(e){e&&e.data?o.succeeded():o.failed(),n&&n.setMessage(o.getMessage())})}),s.then(function(){n&&o.isProcessed()&&(n.stick(!1),setTimeout(function(){n.remove()},6e3))}),s.then(function(){"function"==typeof r&&r()})},Ee=function(){document.selection&&document.selection.empty?document.selection.empty():window.getSelection&&window.getSelection().removeAllRanges()},Oe=function(e){var t=null,i=xe(e,!0);if(i=d.settings.callbacks.beforeSelectItem(e,i),window.tinyMCEPopup){var r=tinyMCEPopup.getWindowArg("window");return r.document.getElementById(tinyMCEPopup.getWindowArg("input")).value=i,void 0!==r.ImageDialog&&(r.ImageDialog.getImageData&&r.ImageDialog.getImageData(),r.ImageDialog.showPreviewImage&&r.ImageDialog.showPreviewImage(i)),void tinyMCEPopup.close()}if(N.param("field_name")&&(parent.document.getElementById(N.param("field_name")).value=i,void 0!==parent.tinyMCE&&parent.tinyMCE.activeEditor.windowManager.close(),void 0!==parent.$.fn.colorbox&&parent.$.fn.colorbox.close()),N.param("ImperaviElementId"))if(window.opener);else{var n=N.param("ImperaviElementId"),o=parent.$("#"+n).redactor("core.getObject");o&&(o.modal.close(),o.buffer.set(),fe(e.attributes.name)?o.insert.html('<img src="'+i+'">'):o.insert.html('<a href="'+i+'">'+e.attributes.name+"</a>"))}if(N.param("CKEditor")&&(window.opener?window.opener.CKEDITOR.tools.callFunction(N.param("CKEditorFuncNum"),i):(parent.CKEDITOR.tools.callFunction(N.param("CKEditorFuncNum"),i),parent.CKEDITOR.tools.callFunction(N.param("CKEditorCleanUpFuncNum")))),window.opener&&"function"==typeof window.opener.SetUrl)if(e.attributes.width){var s=i,a=e.attributes.width,l=e.attributes.height;window.opener.SetUrl(s,a,l)}else window.opener.SetUrl(i);window.opener&&(t=window.opener),window.parent&&window.self!==window.parent&&(t=window.parent),t&&t.postMessage({source:"richfilemanager",preview_url:i},"*"),d.settings.callbacks.afterSelectItem(e,i,t)},Ie=function(e){d.prompt({message:W("new_filename"),value:k.options.allowChangeExtensions?e.attributes.name:le(e.attributes.name),okBtn:{label:W("action_rename"),autoClose:!1,click:function(t,i){var r=e.id,n=i.getInputValue();if(n){if(!k.options.allowChangeExtensions){var o=ae(e.attributes.name);o.length>0&&(n=n+"."+o)}if(ee(r)&&!Z(n)){var s="<p>"+W("INVALID_FILE_TYPE")+"</p>";return"ALLOW_LIST"==k.security.extensions.policy&&(s+="<p>"+W("ALLOWED_FILE_TYPE").replace("%s",k.security.extensions.restrictions.join(", "))+".</p>"),"DISALLOW_LIST"==k.security.extensions.policy&&(s+="<p>"+W("DISALLOWED_FILE_TYPE").replace("%s",k.security.extensions.restrictions.join(", "))+".</p>"),void d.error(s)}ke("GET",{mode:"rename",old:r,new:n}).done(function(e){if(e.data){var t=e.data,n=_.treeModel.findByParam("id",r);if(n&&("folder"===n.rdo.type&&(n.nodeTitle(t.attributes.name),_.treeModel.actualizeNodeObject(n,r,t.id)),"file"===n.rdo.type)){var o=n.parentNode(),s=_.treeModel.createNode(t);n.remove(),o&&_.treeModel.appendNodes(o,s)}if(_.itemsModel.parentItem().id===r)_.itemsModel.parentItem().id=t.id;else{var a=_.itemsModel.findByParam("id",r);if(a){a.remove();var l=_.itemsModel.createItem(t);_.itemsModel.appendItems(l)}}_.currentPath()===r&&_.itemsModel.loadDataList(t.id),_.previewFile()&&_.previewModel.rdo().id===r&&_.previewModel.applyObject(t),i.closeDialog(),k.options.showConfirmation&&d.success(W("successful_rename"))}}).fail(X)}else d.error(W("new_filename"))}},cancelBtn:{label:W("cancel")}})},Ne=function(e,t){var i=e.length,r=i>1?W("prompt_move_multiple").replace("%s",i):W("prompt_move");d.prompt({message:r,value:_.currentPath(),okBtn:{label:W("action_move"),autoClose:!1,click:function(e,i){var r=i.getInputValue();r?(r=re(r,"/")+"/",t(r)):d.error(W("prompt_foldername"))}},cancelBtn:{label:W("cancel")},template:{dialogInput:'<input data-alertify-input type="text" value="" /><div class="prompt-info">'+W("help_move")+"</div>"}})},Te=function(e,t){return ke("GET",{mode:"copy",source:e.id,target:t}).done(function(e){if(e.data){var i=e.data;_.addElements(i,t),alertify.clearDialogs(),k.options.showConfirmation&&d.success(W("successful_copied"))}}).fail(X)},Pe=function(e,t){return ke("GET",{mode:"move",old:e.id,new:t}).done(function(i){if(i.data){var r=i.data;_.removeElement(e),_.addElements(r,t),_.currentPath()===e.id&&_.itemsModel.loadDataList(r.id),_.previewFile()&&_.previewModel.rdo().id===e.id&&_.previewFile(!1),alertify.clearDialogs(),k.options.showConfirmation&&d.success(W("successful_moved"))}}).fail(X)},Fe=function(e,t){var i=e.length,r=i>1?W("confirm_delete_multiple").replace("%s",i):W("confirm_delete");d.confirm({message:r,okBtn:{label:W("yes"),click:function(e,i){t()}},cancelBtn:{label:W("no")}})},De=function(e){return ke("GET",{mode:"delete",path:e}).done(function(e){if(e.data){var t=e.data;if(_.removeElement(t),"folder"===t.type&&ne(_.currentPath(),t.id)){var i=ce(t.id);_.itemsModel.loadDataList(i)}_.previewFile()&&_.previewModel.rdo().id===t.id&&_.previewFile(!1),k.options.showConfirmation&&d.success(W("successful_delete"))}}).fail(X)},ze=function(t){var i={mode:"download",path:t.id};e.fileDownload(Ce(i),{failCallback:function(t,i,r){var n=e.parseJSON(t);e.isPlainObject(n)&&n.errors&&J(n.errors)}})},Ae=function(t){var i=e("#fm-js-editor-form").serializeArray();ke("POST",i).done(function(e){if(e.data){var t=e.data,i=_.previewModel,r=i.editor.content();i.rdo(t),i.viewer.content(r),i.closeEditor();var n=_.itemsModel.createItem(t),o=_.itemsModel.findByParam("id",t.id);_.itemsModel.objects.replace(o,n),d.success(W("successful_edit"))}}).fail(X)},Ue=function(e){return ke("GET",{mode:"readfile",path:e.id},"text").fail(X)},Be=function(e){return ke("GET",{mode:"readfolder",path:e}).fail(X)},Re=function(e,t){return ke("GET",{mode:"seekfolder",path:e,string:t}).fail(X)},He=function(e){return ke("GET",{mode:"getinfo",path:e}).fail(X)},We=function(){return ke("GET",{mode:"summarize"}).done(function(t){if(t.data){var i=t.data.attributes,r=Q(i.size,!0);if(i.sizeLimit>0){var n=Q(i.sizeLimit,!0),o=100*i.size/i.sizeLimit;r+=" ("+Math.round(100*o)/100+"%) "+W("of")+" "+n}_.summaryModel.files(i.files),_.summaryModel.folders(i.folders),_.summaryModel.size(r),_.summaryModel.enabled(!0);var s=e("#summary-popup").clone().show();_.summaryModel.enabled(!1),d.alert(s[0].outerHTML)}}).fail(X)},qe=function(e){d.prompt({message:W("prompt_extract"),value:_.currentPath(),okBtn:{label:W("action_extract"),autoClose:!1,click:function(t,i){var r=i.getInputValue();r?(r=re(r,"/")+"/",Ge(e,r)):d.error(W("prompt_foldername"))}},cancelBtn:{label:W("cancel")}})},Ge=function(e,t){ke("POST",{mode:"extract",source:e.id,target:t}).done(function(e){e.data&&(_.addElements(e.data,t),alertify.clearDialogs(),k.options.showConfirmation&&d.success(W("successful_extracted")))}).fail(X)},Ke=function(t,i,r,n){var o=n||[r];switch(t){case"select":Oe(r);break;case"download":e.each(o,function(e,t){ze(t)});break;case"rename":Ie(r);break;case"move":Ne(o,function(e){_e(o,function(t,i){return Pe(i,e)})});break;case"delete":Fe(o,function(){_e(o,function(e,t){return De(t.id)})});break;case"extract":qe(r);break;case"copy":_.clipboardModel.copy(o);break;case"cut":_.clipboardModel.cut(o);break;case"copyUrl":var s=new Clipboard(i.$selected[0],{text:function(e){return Le(r)}});s.on("success",function(e){d.success(W("copied")),s.destroy()})}},Ve=function(){if(k.options.browseOnly)return!1;k.upload.multiple?M.unbind().click(function(){if(-1===S.indexOf("upload"))return d.error(W("NOT_ALLOWED")),!1;var t=null,i=_.currentPath(),r=tmpl("tmpl-fileupload-container",{folder:W("current_folder")+i,info:W("upload_files_number_limit").replace("%s",k.upload.maxNumberOfFiles)+" "+W("upload_file_size_limit").replace("%s",Q(k.upload.fileSizeLimit,!0)),lang:E.getTranslations()});"ALLOW_LIST"==k.security.extensions.policy&&(t=new RegExp("(\\.|\\/)("+k.security.extensions.restrictions.join("|")+")$","i")),d.dialog({message:r,width:"auto",buttons:[{type:"ok",label:W("action_upload"),autoClose:!1,click:function(e,t){o.children(".upload-item").length>0?o.find(".button-start").trigger("click"):d.error(W("upload_choose_file"))}},{label:W("action_select"),closeOnClick:!1,click:function(t,i){e("#fileupload",n).trigger("click")}},{type:"cancel",label:W("close")}]});var n=e(".fm-fileupload-container"),o=e(".dropzone",n),s=e(".dropzone-wrapper",n),a=e("#total-progress",n).children();k.customScrollbar.enabled&&s.mCustomScrollbar({theme:k.customScrollbar.theme,scrollButtons:{enable:k.customScrollbar.button},advanced:{autoExpandHorizontalScroll:!0,updateOnContentResize:!0},callbacks:{onOverflowY:function(){s.find(".mCSB_container").css({"margin-right":s.find(".mCSB_scrollTools").width()})},onOverflowYNone:function(){s.find(".mCSB_container").css({"margin-right":"auto"})}},axis:"y"}),s.on("click",function(t){(t.target===this||e(t.target).parent()[0]===this||t.target===o[0]||e(t.target).parent().hasClass("default-message"))&&e("#fileupload",n).trigger("click")}),o.on("click",".button-start",function(t){var i=e(this);i.parent().parent().data().submit(),i.remove()}),o.on("click",".button-abort",function(t){var i=e(this).parent().parent().data(),r=i.files[0].context;i.abort(),r.find(".error-message").text(W("upload_aborted")),r.addClass("aborted")}),o.on("click",".button-resume",function(t){function r(i){e.blueimp.fileupload.prototype.options.add.call(e("#fileupload")[0],t,i),i.submit()}var n=e(this).parent().parent().data(),o=n.files[0];if(o.chunkUploaded){var s=i+o.serverName;He(s).then(function(e){e.data&&(n.uploadedBytes=Number(e.data.attributes.size),n.uploadedBytes||(o.chunkUploaded=void 0),r(n))})}else r(n)}),o.on("click",".button-remove",function(t){var r=e(this),n=r.parent().parent().data().files[0];n.chunkUploaded&&De(i+n.serverName),r.closest(".upload-item").remove(),l()}),o.on("click",".button-info",function(t){var i=e(this).closest(".upload-item");if(i.hasClass("error")){var r=i.find(".error-message");d.error(r.text())}});var l=function(){o.children(".upload-item").length>0?o.addClass("started"):o.removeClass("started")},c=_.filterModel.getExtensions();c&&e("#fileupload").attr("accept",c.map(function(e){return"."+e}).join()),e("#fileupload",n).fileupload({autoUpload:!1,sequentialUploads:!0,dataType:"json",dropZone:o,maxChunkSize:k.upload.chunkSize,url:Ce(),paramName:"files",singleFileUploads:!0,formData:Me("POST",{mode:"upload",path:i}),maxNumberOfFiles:k.upload.maxNumberOfFiles,acceptFileTypes:t,maxFileSize:k.upload.fileSizeLimit,messages:{maxNumberOfFiles:W("upload_files_number_limit").replace("%s",k.upload.maxNumberOfFiles),acceptFileTypes:W("upload_file_type_invalid"),maxFileSize:W("upload_file_too_big")+" "+W("upload_file_size_limit").replace("%s",Q(k.upload.fileSizeLimit,!0))},previewMaxHeight:120,previewMaxWidth:120,previewCrop:!0}).on("fileuploadadd",function(t,i){var r=o.children(".upload-item");e.each(i.files,function(t,n){if(r.length>=k.upload.maxNumberOfFiles)return d.error(W("upload_files_number_limit").replace("%s",k.upload.maxNumberOfFiles),{logClass:"fileuploadadd",unique:!0}),!1;n.formattedSize=Q(n.size);var s=e(tmpl("tmpl-upload-item",{file:n,lang:E.getTranslations(),imagesPath:d.settings.baseUrl+"/scripts/jQuery-File-Upload/img"}));n.context=s,s.find(".buttons").data(i),s.appendTo(o)}),l()}).on("fileuploadsend",function(t,i){if(!1===d.settings.callbacks.beforeSendRequest(i.type,i.formData))return e.each(i.files,function(e,t){var i=t.context;i.find(".error-message").text(W("NOT_ALLOWED")),i.removeClass("added process").addClass("error")}),!1;e.each(i.files,function(e,t){var r=t.context;r.removeClass("added aborted error").addClass("process"),t.chunkUploaded&&i.total===i.uploadedBytes&&r.remove()})}).on("fileuploadfail",function(t,i){e.each(i.files,function(e,t){t.error=W("upload_failed"),t.context.removeClass("added process").addClass("error")})}).on("fileuploaddone",function(t,i){var r=i.result;e.each(i.files,function(e,t){var i=t.context;r&&r.errors?(i.removeClass("added process").addClass("error"),i.find(".error-message").text(Y(r.errors[0])),i.find(".button-start").remove()):i.remove()})}).on("fileuploadalways",function(t,i){var r=i.result;e.each(i.files,function(e,t){if(r&&r.data&&r.data[e]){var i=r.data[e];_.removeElement(i),_.addElements(i,_.currentPath())}});var n=o.children(".upload-item");0===n.filter(".added").length&&0===n.filter(".process").length&&(0===n.length&&(alertify.clearDialogs(),k.options.showConfirmation&&d.success(W("upload_successful_files"))),n.filter(".error").length&&d.error(W("upload_partially")+"<br>"+W("upload_failed_details"))),l()}).on("fileuploadchunkdone",function(t,i){var r=i.result;e.each(i.files,function(e,t){if(r.data&&r.data[e]){var i=r.data[e];_.removeElement(i),_.addElements(i,_.currentPath()),t.serverName=i.attributes.name,t.chunkUploaded=1}})}).on("fileuploadprocessalways",function(t,i){e.each(i.files,function(e,t){var i=t.context;void 0!==i&&(t.preview&&(i.find(".image").append(t.preview),i.find(".preview").removeClass("file-preview").addClass("image-preview")),t.error&&(i.removeClass("added process").addClass("error"),i.find(".error-message").text(t.error),i.find(".button-start").remove()))})}).on("fileuploadprogress",function(t,i){e.each(i.files,function(e,t){var r=t.context,n=parseInt(i.loaded/i.total*100,10);r.find(".progress-bar").css("width",n+"%")})}).on("fileuploadprogressall",function(e,t){var i=parseInt(t.loaded/t.total*100,10);a.css("width",i+"%")})}):(M.unbind().click(function(){if(-1===S.indexOf("upload"))return d.error(W("NOT_ALLOWED")),!1;e("#newfile").trigger("click")}),f.fileupload({autoUpload:!0,dataType:"json",url:Ce(),paramName:"files",maxChunkSize:k.upload.chunkSize}).on("fileuploadadd",function(e,t){M.data(t)}).on("fileuploadsubmit",function(e,t){t.formData=Me("POST",{mode:"upload",path:_.currentPath()}),M.addClass("loading").prop("disabled",!0),M.children("span").text(W("loading_data"))}).on("fileuploadsend",function(e,t){if(!1===d.settings.callbacks.beforeSendRequest(t.type,t.formData))return d.error(W("NOT_ALLOWED")),!1}).on("fileuploadalways",function(e,t){M.removeData().removeClass("loading").prop("disabled",!1),M.children("span").text(W("action_upload"));var i=t.result;if(i&&i.errors&&d.error(W("upload_failed")+"<br>"+Y(i.errors[0])),i&&i.data){var r=i.data[0];_.removeElement(r),_.addElements(r,_.currentPath()),k.options.showConfirmation&&d.success(W("upload_successful_file"))}}).on("fileuploadchunkdone",function(e,t){var i=t.result;if(i.data&&i.data[0]){var r=i.data[0];_.removeElement(r),_.addElements(r,_.currentPath())}}).on("fileuploadfail",function(e,t){d.error(W("upload_failed"))}))};!function(){var t=e.Deferred();t.then(function(){return P()}).then(function(){return D()}).then(function(e,t){return F()}).then(function(){return z()}).then(function(){A(function(){U()})}),t.resolve()}(),e(window).resize(d.setDimensions)}}(jQuery),$.fn.richFilemanager=function(e){return this.each(function(){if(void 0==$(this).data("richFilemanager")){var t=new $.richFilemanagerPlugin(this,e);$(this).data("richFilemanager",t)}})},window.location.origin||(window.location.origin=window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:""));